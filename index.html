<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rifas Online â€” Plataforma de Rifas Digital</title>
  <meta name="description" content="Plataforma de rifas digitais com pagamento PIX, gestÃ£o de organizadores e sorteio seguro">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸŸï¸</text></svg>">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Segoe UI',-apple-system,sans-serif; background:#0a0f1a; color:#E5E7EB; }
    #root { min-height:100vh; }
    ::-webkit-scrollbar { width:5px; }
    ::-webkit-scrollbar-track { background:#111827; }
    ::-webkit-scrollbar-thumb { background:#D4A843; border-radius:3px; }
    ::selection { background:#D4A84366; }
  </style>
</head>
<body>
  <div id="root"><div style="display:flex;align-items:center;justify-content:center;min-height:100vh;color:#9CA3AF">ğŸŸï¸ Carregando...</div></div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
  <script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

// ====== SUPABASE CONFIG ======
// SUBSTITUA com suas credenciais do Supabase
const SUPABASE_URL = "https://qewbnvbqdqryaekicdae.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFld2JudmJxZHFyeWFla2ljZGFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwODg5MDIsImV4cCI6MjA4NjY2NDkwMn0.SMuE_GGVLtISBXhiV2o_OPZkEvGV_SIEfcT3Keqzrns";

// Minimal Supabase client (no SDK needed)
const sb = {
  headers: { "apikey": SUPABASE_ANON_KEY, "Authorization": `Bearer ${SUPABASE_ANON_KEY}`, "Content-Type": "application/json", "Prefer": "return=representation" },
  async query(table, { select = "*", filter = "", single = false, order = "" } = {}) {
    let url = `${SUPABASE_URL}/rest/v1/${table}?select=${encodeURIComponent(select)}${filter}${order ? `&order=${order}` : ""}`;
    const r = await fetch(url, { headers: this.headers });
    if (!r.ok) throw new Error(await r.text());
    const d = await r.json();
    return single ? d[0] || null : d;
  },
  async insert(table, data) {
    const r = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, { method: "POST", headers: this.headers, body: JSON.stringify(data) });
    if (!r.ok) throw new Error(await r.text());
    return r.json();
  },
  async update(table, filter, data) {
    const r = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${filter}`, { method: "PATCH", headers: { ...this.headers, "Prefer": "return=representation" }, body: JSON.stringify(data) });
    if (!r.ok) throw new Error(await r.text());
    return r.json();
  },
  async del(table, filter) {
    const r = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${filter}`, { method: "DELETE", headers: this.headers });
    if (!r.ok) throw new Error(await r.text());
  },
  async rpc(fn, params) {
    const r = await fetch(`${SUPABASE_URL}/rest/v1/rpc/${fn}`, { method: "POST", headers: this.headers, body: JSON.stringify(params) });
    if (!r.ok) throw new Error(await r.text());
    return r.json();
  }
};

// ====== UTILS ======
const T = { bg:"#0a0f1a", card:"#111827", cardAlt:"#0d1321", gold:"#D4A843", goldL:"#F5DEB3", accent:"#22D3EE", ok:"#34D399", warn:"#FBBF24", err:"#F87171", txt:"#E5E7EB", mut:"#9CA3AF", bdr:"#1E293B", inp:"#1a2332", purp:"#A78BFA" };
const fmt = (v) => new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(v);
const fmtD = (d) => d ? new Date(d).toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}) : "";
function secureRandom(max) { const a = new Uint32Array(4); crypto.getRandomValues(a); return ((a[0]^a[1]^a[2]^a[3])>>>0) % max; }
function useIsMobile() { const [m,s] = useState(window.innerWidth < 768); useEffect(() => { const h = () => s(window.innerWidth < 768); window.addEventListener("resize",h); return () => window.removeEventListener("resize",h); },[]); return m; }
async function hashPass(str) { const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(str + "rifas_salt_2026")); return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,"0")).join(""); }
function genCode() { const c = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789"; let s = "RF-"; for(let i=0;i<4;i++) s += c[secureRandom(c.length)]; return s; }

// ====== LOADING & TOAST ======
function Loading({ text }) { return <div style={{ textAlign:"center", padding:40 }}><div style={{ fontSize:28, marginBottom:8, animation:"spin 1s linear infinite" }}>ğŸŸï¸</div><div style={{ color:T.mut, fontSize:12 }}>{text || "Carregando..."}</div><style>{`@keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}`}</style></div>; }
function Toast({ msg, type, onClose }) { if(!msg) return null; const bg = type === "ok" ? T.ok : type === "err" ? T.err : T.warn; return <div style={{ position:"fixed", top:16, left:"50%", transform:"translateX(-50%)", padding:"8px 18px", borderRadius:8, background:bg, color:"#fff", fontSize:12, fontWeight:700, zIndex:99999, boxShadow:"0 4px 20px rgba(0,0,0,0.3)", cursor:"pointer" }} onClick={onClose}>{msg}</div>; }
function useToast() { const [t,setT] = useState(null); const show = (msg,type="ok") => { setT({msg,type}); setTimeout(()=>setT(null), 3000); }; return [t, show, () => setT(null)]; }

// ====== UI COMPONENTS ======
function Input({label,type="text",value,onChange,placeholder,prefix,suffix,textarea,disabled,error,required}){
  const C = textarea ? "textarea" : "input";
  return (<div style={{marginBottom:12}}>{label && <label style={{display:"block",fontSize:11,fontWeight:600,color:error?T.err:T.mut,marginBottom:4,textTransform:"uppercase",letterSpacing:0.5}}>{label}{required && <span style={{color:T.err}}> *</span>}</label>}<div style={{position:"relative"}}>{prefix && <span style={{position:"absolute",left:10,top:"50%",transform:"translateY(-50%)",color:T.mut,fontSize:13,pointerEvents:"none"}}>{prefix}</span>}<C type={type} value={value} onChange={e=>onChange(e.target.value)} placeholder={placeholder} disabled={disabled} style={{width:"100%",padding:textarea?"10px 12px":"9px 12px",paddingLeft:prefix?34:12,background:T.inp,border:`1px solid ${error?T.err:T.bdr}`,borderRadius:8,color:T.txt,fontSize:14,outline:"none",resize:textarea?"vertical":"none",minHeight:textarea?60:"auto",opacity:disabled?0.5:1,boxSizing:"border-box"}} onFocus={e=>{e.target.style.borderColor=T.gold}} onBlur={e=>{e.target.style.borderColor=error?T.err:T.bdr}}/>{suffix && <span style={{position:"absolute",right:10,top:"50%",transform:"translateY(-50%)",color:T.mut,fontSize:11}}>{suffix}</span>}</div>{error && <span style={{fontSize:11,color:T.err,marginTop:2,display:"block"}}>{error}</span>}</div>);
}
function Btn({children,onClick,variant="primary",size="md",disabled,block,style:cs}){
  const vs={primary:{bg:T.gold,c:T.bg},secondary:{bg:T.bdr,c:T.txt},success:{bg:T.ok,c:T.bg},danger:{bg:"#DC2626",c:"#fff"},ghost:{bg:"transparent",c:T.mut},accent:{bg:T.accent,c:T.bg},purple:{bg:T.purp,c:"#fff"}};
  const sz={sm:{p:"5px 10px",f:11},md:{p:"9px 16px",f:13},lg:{p:"12px 24px",f:15}};const v=vs[variant]||vs.primary;const s=sz[size];
  return <button onClick={onClick} disabled={disabled} style={{padding:s.p,border:"none",borderRadius:8,background:disabled?T.bdr:v.bg,color:disabled?T.mut:v.c,fontSize:s.f,fontWeight:700,cursor:disabled?"not-allowed":"pointer",opacity:disabled?0.5:1,width:block?"100%":"auto",...cs}}>{children}</button>;
}
function Card({children,title,subtitle,headerRight,style:cs}){
  return (<div style={{background:T.card,borderRadius:12,border:`1px solid ${T.bdr}`,overflow:"hidden",...cs}}>{title && <div style={{padding:"12px 16px",borderBottom:`1px solid ${T.bdr}`,display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:6}}><div><h3 style={{margin:0,fontSize:14,fontWeight:700,color:T.txt}}>{title}</h3>{subtitle && <p style={{margin:"2px 0 0",fontSize:11,color:T.mut}}>{subtitle}</p>}</div>{headerRight}</div>}<div style={{padding:"12px 16px"}}>{children}</div></div>);
}
function NumSearch({value,onChange,total}){
  return (<div style={{position:"relative",marginBottom:8}}><span style={{position:"absolute",left:10,top:"50%",transform:"translateY(-50%)",fontSize:13}}>ğŸ”</span><input type="text" value={value} onChange={e=>onChange(e.target.value)} placeholder={`Buscar nÂº (1-${total})...`} style={{width:"100%",padding:"8px 12px 8px 30px",borderRadius:8,border:`1px solid ${T.bdr}`,background:T.inp,color:T.txt,fontSize:12,boxSizing:"border-box",outline:"none"}} onFocus={e=>{e.target.style.borderColor=T.gold}} onBlur={e=>{e.target.style.borderColor=T.bdr}}/>{value && <button onClick={()=>onChange("")} style={{position:"absolute",right:8,top:"50%",transform:"translateY(-50%)",background:"none",border:"none",color:T.mut,cursor:"pointer"}}>âœ•</button>}</div>);
}

// ====== RECEIPT MODAL ======
function ReceiptModal({open,onClose,rifa,buyer,numbers}){
  if(!open||!rifa||!buyer) return null;
  const total = numbers.length * rifa.price_per_number;
  const isPaid = numbers.every(n => n.paid);
  const pad = rifa.total_numbers > 99 ? 3 : 2;
  const plain = (wa) => { const b=wa?"*":""; return [`ğŸŸï¸ ${b}Rifas Online${b}`,`${b}Rifa:${b} ${rifa.rifa_name}`,`${b}CÃ³digo:${b} ${rifa.code}`,`${b}PrÃªmio:${b} ${rifa.prize}`,`${b}Comprador:${b} ${buyer.buyer_name}`,`${b}NÃºmeros:${b} ${numbers.map(n=>String(n.number).padStart(pad,"0")).join(", ")}`,`${b}Total:${b} ${fmt(total)}`,`${b}Status:${b} ${isPaid?"âœ… PAGO":"â³ PENDENTE"}`,!isPaid&&rifa.pix_key?`\n${b}PIX:${b} ${rifa.pix_key}\n${b}Valor:${b} ${fmt(total)}`:""].filter(Boolean).join("\n"); };
  return (
    <div onClick={onClose} style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.75)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:99999,padding:10,backdropFilter:"blur(4px)"}}>
      <div onClick={e=>e.stopPropagation()} style={{background:"#fefbf3",borderRadius:14,width:"100%",maxWidth:460,maxHeight:"90vh",overflow:"auto",color:"#222"}}>
        <div style={{textAlign:"center",padding:"16px 16px 10px",borderBottom:"3px double #D4A843"}}><div style={{fontSize:22}}>ğŸŸï¸</div><h2 style={{margin:"2px 0",fontSize:15,fontWeight:800,color:"#1a1a3e",fontFamily:"Georgia,serif"}}>Rifas Online</h2><div style={{padding:"2px 8px",borderRadius:4,background:"#A78BFA22",color:"#A78BFA",fontSize:10,fontWeight:800,fontFamily:"monospace",display:"inline-block"}}>{rifa.code}</div></div>
        <div style={{padding:"10px 16px"}}>
          {[["Rifa",rifa.rifa_name],["PrÃªmio",rifa.prize],["Comprador",buyer.buyer_name],["Tel",buyer.buyer_phone||"â€”"],["Cotas",numbers.length],["Total",fmt(total)]].map(([l,v],i) => (<div key={i} style={{display:"flex",justifyContent:"space-between",padding:"4px 0",borderBottom:"1px dashed #e0d5c0",fontSize:12}}><span style={{color:"#888"}}>{l}</span><span style={{fontWeight:l==="Total"?800:600,color:l==="Total"?"#D4A843":"#222"}}>{v}</span></div>))}
          <div style={{display:"flex",flexWrap:"wrap",gap:3,justifyContent:"center",margin:"10px 0"}}>{numbers.map(n => (<div key={n.number} style={{width:30,height:30,borderRadius:5,display:"flex",alignItems:"center",justifyContent:"center",fontWeight:700,fontSize:10,fontFamily:"monospace",background:n.paid?"#d4edda":"#fff3cd",color:n.paid?"#155724":"#856404",border:`2px solid ${n.paid?"#28a745":"#ffc107"}`}}>{String(n.number).padStart(pad,"0")}</div>))}</div>
          <div style={{textAlign:"center",padding:5,borderRadius:5,fontWeight:700,fontSize:11,background:isPaid?"#d4edda":"#fff3cd",color:isPaid?"#155724":"#856404"}}>{isPaid?"âœ… CONFIRMADO":"â³ PENDENTE"}</div>
          {!isPaid && rifa.pix_key && <div style={{background:"#f0f7ff",border:"1px solid #b3d4fc",borderRadius:6,padding:8,marginTop:8,textAlign:"center"}}><div style={{fontSize:10,color:"#555"}}>PIX:</div><div style={{fontSize:14,fontWeight:800,color:"#1a1a3e",wordBreak:"break-all"}}>{rifa.pix_key}</div><div style={{fontSize:11,fontWeight:700,marginTop:3}}>Valor: {fmt(total)}</div></div>}
        </div>
        <div style={{display:"flex",gap:4,padding:"6px 14px 14px",justifyContent:"center",flexWrap:"wrap"}}>
          <button onClick={()=>{navigator.clipboard.writeText(plain(false)).then(()=>alert("ğŸ“‹ Copiado!"));}} style={{padding:"5px 10px",borderRadius:6,border:"none",background:"#D4A843",color:"#1a1a3e",fontWeight:700,fontSize:10,cursor:"pointer"}}>ğŸ“‹ Copiar</button>
          <button onClick={()=>{window.open(`https://wa.me/${(buyer.buyer_phone||"").replace(/\D/g,"")}?text=${encodeURIComponent(plain(true))}`,"_blank");}} style={{padding:"5px 10px",borderRadius:6,border:"none",background:"#25D366",color:"#fff",fontWeight:700,fontSize:10,cursor:"pointer"}}>ğŸ“± Zap</button>
          <button onClick={onClose} style={{padding:"5px 10px",borderRadius:6,border:"1px solid #ddd",background:"#fff",color:"#666",fontWeight:600,fontSize:10,cursor:"pointer"}}>Fechar</button>
        </div>
      </div>
    </div>
  );
}

// ====== PUBLIC VIEW ======
function PublicView({ toast }) {
  const mob = useIsMobile();
  const [rifas, setRifas] = useState([]);
  const [loading, setLoading] = useState(true);
  const [selRifa, setSelRifa] = useState(null);
  const [nums, setNums] = useState([]);
  const [sel, setSel] = useState([]);
  const [name, setName] = useState(""); const [phone, setPhone] = useState(""); const [email, setEmail] = useState("");
  const [errs, setErrs] = useState({});
  const [step, setStep] = useState("list");
  const [done, setDone] = useState(null);
  const [ns, setNs] = useState("");
  const [rifaSearch, setRifaSearch] = useState("");
  const [receipt, setReceipt] = useState(null);

  useEffect(() => { loadRifas(); }, []);

  const loadRifas = async () => {
    try {
      setLoading(true);
      const r = await sb.query("rifas", { filter: "&status=eq.active", order: "created_at.desc" });
      setRifas(r);
    } catch(e) { console.error(e); } finally { setLoading(false); }
  };

  const loadNums = async (rifaId) => {
    try {
      const n = await sb.query("numbers", { filter: `&rifa_id=eq.${rifaId}`, order: "number.asc" });
      setNums(n);
    } catch(e) { console.error(e); }
  };

  const selectRifa = async (r) => { setSelRifa(r); setStep("select"); setSel([]); setNs(""); await loadNums(r.id); };

  const validate = () => {
    const e = {};
    if (!name.trim()) e.name = "Nome obrigatÃ³rio";
    if (!phone.trim()) e.phone = "WhatsApp obrigatÃ³rio";
    else if (phone.replace(/\D/g,"").length < 10) e.phone = "MÃ­n 10 dÃ­gitos";
    if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) e.email = "E-mail invÃ¡lido";
    if (!sel.length) e.numbers = "Selecione nÃºmeros";
    setErrs(e); return !Object.keys(e).length;
  };

  const doBuy = async () => {
    try {
      const pid = Date.now().toString(36) + Math.random().toString(36).substr(2,6);
      const buyerData = { buyer_name: name.trim(), buyer_phone: phone.trim(), buyer_email: email.trim(), purchase_id: pid, bought_at: new Date().toISOString() };
      // Update each selected number
      for (const num of sel) {
        await sb.update("numbers", `rifa_id=eq.${selRifa.id}&number=eq.${num}&buyer_name=is.null`, buyerData);
      }
      const boughtNums = sel.map(n => ({ number: n, paid: false }));
      setDone({ buyer: buyerData, numbers: boughtNums, total: sel.length * selRifa.price_per_number });
      setStep("pix");
      toast("âœ… NÃºmeros reservados!", "ok");
    } catch(e) { toast("Erro ao reservar: " + e.message, "err"); }
  };

  const filtered = rifas.filter(r => { if (!rifaSearch) return true; const s = rifaSearch.toUpperCase(); return (r.code||"").includes(s) || r.rifa_name.toLowerCase().includes(rifaSearch.toLowerCase()); });

  if (loading) return <Loading text="Carregando rifas..." />;

  // PIX screen
  if (step === "pix" && done) {
    return (
      <div style={{maxWidth:460,margin:"0 auto",padding:mob?"14px 10px":"20px"}}>
        <Card><div style={{textAlign:"center"}}>
          <div style={{fontSize:40}}>âœ…</div>
          <h2 style={{color:T.ok,fontSize:17,fontWeight:800,marginBottom:4}}>Reservado!</h2>
          <p style={{color:T.mut,fontSize:11,marginBottom:10}}>Realize o PIX para confirmar.</p>
          {selRifa.pix_key && <div style={{background:T.inp,borderRadius:10,padding:12,border:`2px dashed ${T.gold}44`,marginBottom:10}}>
            <div style={{fontSize:9,color:T.mut,textTransform:"uppercase",letterSpacing:1}}>Chave PIX</div>
            <div style={{fontSize:16,fontWeight:800,color:T.gold,fontFamily:"monospace",wordBreak:"break-all",margin:"4px 0"}}>{selRifa.pix_key}</div>
            <div style={{fontSize:10,color:T.mut}}>Titular: {selRifa.pix_name || selRifa.organizer_name}</div>
            <div style={{marginTop:8,padding:6,background:T.warn+"11",borderRadius:5}}><div style={{fontSize:22,fontWeight:900,color:T.gold}}>{fmt(done.total)}</div></div>
            <button onClick={()=>{navigator.clipboard.writeText(selRifa.pix_key).then(()=>toast("ğŸ“‹ PIX copiado!","ok"));}} style={{marginTop:6,padding:"4px 10px",borderRadius:5,border:`1px solid ${T.accent}44`,background:T.accent+"11",color:T.accent,fontSize:10,fontWeight:600,cursor:"pointer"}}>ğŸ“‹ Copiar PIX</button>
          </div>}
          <div style={{display:"flex",gap:5,justifyContent:"center",flexWrap:"wrap"}}>
            <Btn variant="success" size="sm" onClick={()=>setReceipt({rifa:selRifa,buyer:done.buyer,numbers:done.numbers})}>ğŸ–¨ï¸ Comprovante</Btn>
            <Btn variant="secondary" size="sm" onClick={()=>{setStep("list");setSelRifa(null);setSel([]);setDone(null);setName("");setPhone("");setEmail("");loadRifas();}}>â† Rifas</Btn>
          </div>
        </div></Card>
        <ReceiptModal open={!!receipt} onClose={()=>setReceipt(null)} rifa={receipt?.rifa} buyer={receipt?.buyer} numbers={receipt?.numbers} />
      </div>
    );
  }

  // Confirm screen
  if (step === "confirm") {
    const pad = selRifa.total_numbers > 99 ? 3 : 2;
    const total = sel.length * selRifa.price_per_number;
    return (
      <div style={{maxWidth:460,margin:"0 auto",padding:mob?"14px 10px":"20px"}}>
        <Card title="ğŸ“‹ Confirme">
          <div style={{marginBottom:8}}><div style={{fontSize:11,color:T.mut}}>Comprador</div><div style={{fontSize:14,fontWeight:700,color:T.txt}}>{name}</div><div style={{fontSize:11,color:T.mut}}>{phone}</div></div>
          <div style={{marginBottom:8}}><div style={{fontSize:11,color:T.mut}}>NÃºmeros ({sel.length})</div><div style={{display:"flex",flexWrap:"wrap",gap:3}}>{sel.sort((a,b)=>a-b).map(n => <span key={n} style={{padding:"2px 6px",borderRadius:4,background:T.gold+"22",color:T.gold,fontSize:11,fontWeight:700,fontFamily:"monospace"}}>{String(n).padStart(pad,"0")}</span>)}</div></div>
          <div style={{padding:8,borderRadius:8,background:T.gold+"11",textAlign:"center",marginBottom:8}}><div style={{fontSize:22,fontWeight:900,color:T.gold}}>{fmt(total)}</div></div>
          <div style={{display:"flex",gap:6}}><Btn variant="ghost" onClick={()=>setStep("select")}>â† Voltar</Btn><Btn block onClick={doBuy}>âœ… Confirmar</Btn></div>
        </Card>
      </div>
    );
  }

  // Select numbers
  if (step === "select" && selRifa) {
    const pad = selRifa.total_numbers > 99 ? 3 : 2;
    const sold = nums.filter(n => n.buyer_name).length;
    const avail = selRifa.total_numbers - sold;
    const prog = (sold / selRifa.total_numbers) * 100;
    const total = sel.length * selRifa.price_per_number;
    const fNums = nums.filter(n => !ns || n.number.toString().includes(ns));
    const sNum = ns ? parseInt(ns) : null;
    const toggle = (n) => { if (nums.find(x=>x.number===n)?.buyer_name) return; setSel(p => p.includes(n) ? p.filter(x=>x!==n) : [...p,n]); };

    return (
      <div style={{maxWidth:760,margin:"0 auto",padding:mob?"12px 10px":"18px"}}>
        <button onClick={()=>{setStep("list");setSelRifa(null);setSel([]);}} style={{background:"none",border:"none",color:T.mut,fontSize:11,cursor:"pointer",marginBottom:6}}>â† Voltar</button>
        <div style={{textAlign:"center",marginBottom:12,padding:mob?"12px 10px":"18px 14px",background:`linear-gradient(135deg,${T.card},${T.cardAlt})`,borderRadius:12,border:`1px solid ${T.bdr}`}}>
          <div style={{display:"inline-block",padding:"2px 8px",borderRadius:4,background:T.purp+"22",color:T.purp,fontSize:11,fontWeight:800,fontFamily:"monospace",letterSpacing:1}}>{selRifa.code}</div>
          <h1 style={{fontSize:mob?17:20,fontWeight:800,color:T.txt,fontFamily:"'Playfair Display',Georgia,serif",margin:"4px 0"}}>{selRifa.rifa_name}</h1>
          <p style={{fontSize:12,color:T.gold,fontWeight:600}}>ğŸ† {selRifa.prize}</p>
          <div style={{display:"flex",justifyContent:"center",gap:mob?12:20,marginTop:8,flexWrap:"wrap"}}>
            <div><div style={{fontSize:16,fontWeight:900,color:T.gold,fontFamily:"monospace"}}>{fmt(selRifa.price_per_number)}</div><div style={{fontSize:8,color:T.mut}}>POR NÂº</div></div>
            <div><div style={{fontSize:16,fontWeight:900,color:T.accent,fontFamily:"monospace"}}>{avail}</div><div style={{fontSize:8,color:T.mut}}>LIVRES</div></div>
          </div>
          <div style={{margin:"6px auto 0",maxWidth:300,height:4,background:T.bdr,borderRadius:2,overflow:"hidden"}}><div style={{width:`${prog}%`,height:"100%",background:`linear-gradient(90deg,${T.gold},${T.ok})`,borderRadius:2}} /></div>
        </div>
        <div style={{display:"grid",gridTemplateColumns:mob?"1fr":"1.5fr 1fr",gap:12}}>
          <Card title="Escolha nÃºmeros" subtitle={sel.length ? `${sel.length} selecionado(s)` : undefined}>
            <NumSearch value={ns} onChange={setNs} total={selRifa.total_numbers} />
            <div style={{display:"grid",gridTemplateColumns:`repeat(auto-fill,minmax(${mob?32:36}px,1fr))`,gap:3,maxHeight:mob?230:340,overflowY:"auto"}}>
              {fNums.map(n => {
                const s = sel.includes(n.number); const tk = !!n.buyer_name; const sr = sNum===n.number;
                let bg=T.inp,c=T.txt,b=T.bdr;
                if(tk){bg=T.mut+"15";c=T.mut+"66";b="transparent";}else if(s){bg=T.gold+"33";c=T.gold;b=T.gold;}
                if(sr&&!tk&&!s){bg=T.accent+"22";c=T.accent;b=T.accent;}
                return <button key={n.number} onClick={()=>toggle(n.number)} disabled={tk} style={{width:"100%",aspectRatio:"1",display:"flex",alignItems:"center",justifyContent:"center",borderRadius:4,border:`1.5px solid ${b}`,background:bg,color:c,fontSize:9,fontWeight:700,fontFamily:"monospace",cursor:tk?"not-allowed":"pointer",textDecoration:tk?"line-through":"none",boxShadow:sr?`0 0 6px ${T.accent}44`:"none"}}>{String(n.number).padStart(pad,"0")}</button>;
              })}
            </div>
          </Card>
          <Card title="ğŸ“ Seus Dados">
            {sel.length > 0 ? <div style={{padding:5,borderRadius:6,marginBottom:6,background:T.gold+"11",textAlign:"center"}}><div style={{fontSize:18,fontWeight:900,color:T.gold}}>{fmt(total)}</div></div>
            : <div style={{padding:6,borderRadius:6,marginBottom:6,background:T.accent+"0d",textAlign:"center"}}><div style={{fontSize:10,color:T.accent}}>{mob?"â˜ï¸ Selecione acima":"ğŸ‘ˆ Selecione ao lado"}</div></div>}
            <Input label="Nome" value={name} onChange={v=>{setName(v);if(errs.name)setErrs(p=>({...p,name:""}));}} placeholder="Seu nome" required error={errs.name} />
            <Input label="WhatsApp" value={phone} onChange={v=>{setPhone(v);if(errs.phone)setErrs(p=>({...p,phone:""}));}} placeholder="(88) 99999-0000" required error={errs.phone} />
            <Input label="E-mail (opcional)" value={email} onChange={v=>{setEmail(v);if(errs.email)setErrs(p=>({...p,email:""}));}} error={errs.email} />
            <Btn block onClick={()=>{if(validate())setStep("confirm");}}>{sel.length===0?"Selecione nÃºmeros":`Continuar â†’ ${fmt(total)}`}</Btn>
            {sel.length>0 && <Btn variant="ghost" block onClick={()=>setSel([])} size="sm" style={{marginTop:3}}>Limpar</Btn>}
          </Card>
        </div>
      </div>
    );
  }

  // List
  return (
    <div style={{maxWidth:680,margin:"0 auto",padding:mob?"14px 10px":"22px 18px"}}>
      {rifas.length === 0 ? (
        <div style={{textAlign:"center",padding:"50px 16px"}}><div style={{fontSize:44}}>ğŸŸï¸</div><h2 style={{color:T.txt,fontSize:17,fontWeight:700,fontFamily:"'Playfair Display',Georgia,serif"}}>Nenhuma rifa ativa</h2><p style={{color:T.mut,fontSize:12,marginTop:4}}>Volte em breve!</p></div>
      ) : (
        <div style={{display:"flex",flexDirection:"column",gap:10}}>
          <h2 style={{color:T.txt,fontSize:17,fontWeight:800,fontFamily:"'Playfair Display',Georgia,serif",textAlign:"center",margin:0}}>ğŸŸï¸ Rifas DisponÃ­veis</h2>
          <div style={{position:"relative"}}><span style={{position:"absolute",left:10,top:"50%",transform:"translateY(-50%)",fontSize:13}}>ğŸ”</span><input type="text" value={rifaSearch} onChange={e=>setRifaSearch(e.target.value)} placeholder="Buscar por cÃ³digo (RF-XXXX) ou nome..." style={{width:"100%",padding:"8px 12px 8px 30px",borderRadius:8,border:`1px solid ${T.bdr}`,background:T.inp,color:T.txt,fontSize:12,boxSizing:"border-box",outline:"none"}} /></div>
          {filtered.map(r => {
            const sold = 0; // will be loaded on click
            return (
              <div key={r.id} onClick={()=>selectRifa(r)} style={{padding:14,borderRadius:10,background:T.card,border:`1px solid ${T.bdr}`,cursor:"pointer"}} onMouseEnter={e=>{e.currentTarget.style.borderColor=T.gold;}} onMouseLeave={e=>{e.currentTarget.style.borderColor=T.bdr;}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:6}}>
                  <div>
                    <div style={{display:"flex",alignItems:"center",gap:5}}><span style={{padding:"2px 5px",borderRadius:3,background:T.purp+"22",color:T.purp,fontSize:10,fontWeight:800,fontFamily:"monospace"}}>{r.code}</span><h3 style={{margin:0,fontSize:15,fontWeight:700,color:T.txt}}>{r.rifa_name}</h3></div>
                    <p style={{margin:"2px 0",fontSize:12,color:T.gold}}>ğŸ† {r.prize}</p>
                    {r.description && <p style={{margin:"3px 0 0",fontSize:11,color:T.mut}}>{r.description}</p>}
                  </div>
                  <div style={{textAlign:"right"}}><div style={{fontSize:17,fontWeight:900,color:T.gold,fontFamily:"monospace"}}>{fmt(r.price_per_number)}</div><div style={{fontSize:10,color:T.mut}}>{r.total_numbers} nÃºmeros</div></div>
                </div>
              </div>
            );
          })}
          {!filtered.length && <div style={{textAlign:"center",padding:16,color:T.mut}}>Nenhuma rifa encontrada</div>}
        </div>
      )}
    </div>
  );
}

// ====== ORGANIZER PANEL ======
function OrgLogin({ onLogin, onRegister, toast }) {
  const [isReg,setIsReg] = useState(false);
  const [user,setUser] = useState("");const [pass,setPass] = useState("");const [name,setName] = useState("");const [phone,setPhone] = useState("");const [pix,setPix] = useState("");
  const [err,setErr] = useState("");

  const doLogin = async () => {
    try {
      const orgs = await sb.query("organizers", { filter: `&username=eq.${user.trim().toLowerCase()}` });
      const org = orgs[0];
      if (!org) { setErr("UsuÃ¡rio ou senha incorretos"); return; }
      if (org.blocked) { setErr("Conta bloqueada. Contate o admin."); return; }
      const h = await hashPass(pass);
      if (h !== org.pass_hash) { setErr("UsuÃ¡rio ou senha incorretos"); return; }
      onLogin(org);
    } catch(e) { setErr("Erro: " + e.message); }
  };

  const doReg = async () => {
    if (!user.trim()||!pass||!name.trim()||!phone.trim()||!pix.trim()) { setErr("Preencha todos"); return; }
    if (pass.length < 4) { setErr("Senha mÃ­n 4"); return; }
    const u2 = user.trim().toLowerCase();
    if (/[^a-z0-9_]/.test(u2)) { setErr("UsuÃ¡rio: sÃ³ letras, nÃºmeros e _"); return; }
    try {
      const exists = await sb.query("organizers", { filter: `&username=eq.${u2}` });
      if (exists.length) { setErr("UsuÃ¡rio jÃ¡ existe"); return; }
      const h = await hashPass(pass);
      await sb.insert("organizers", { username: u2, pass_hash: h, name: name.trim(), phone: phone.trim(), pix_key: pix.trim() });
      toast("âœ… Conta criada! FaÃ§a login.", "ok");
      setIsReg(false); setErr("");
    } catch(e) { setErr("Erro: " + e.message); }
  };

  return (
    <div style={{display:"flex",alignItems:"center",justifyContent:"center",minHeight:"70vh",padding:16}}>
      <Card title={isReg?"ğŸ“ Cadastro":"ğŸ” Ãrea do Organizador"} style={{maxWidth:380,width:"100%"}}>
        {isReg ? (<>
          <Input label="UsuÃ¡rio" value={user} onChange={v=>{setUser(v);setErr("");}} placeholder="seunome" required />
          <Input label="Senha" type="password" value={pass} onChange={v=>{setPass(v);setErr("");}} placeholder="MÃ­n 4" required />
          <Input label="Nome" value={name} onChange={setName} required />
          <Input label="WhatsApp" value={phone} onChange={setPhone} placeholder="(88) 99999-0000" required />
          <Input label="Chave PIX" value={pix} onChange={setPix} required />
          {err && <div style={{padding:3,borderRadius:4,marginBottom:4,background:T.err+"11",fontSize:10,color:T.err}}>{err}</div>}
          <Btn block onClick={doReg}>Criar Conta</Btn>
          <button onClick={()=>{setIsReg(false);setErr("");}} style={{display:"block",margin:"6px auto 0",background:"none",border:"none",color:T.accent,fontSize:11,cursor:"pointer"}}>JÃ¡ tem conta? Entrar</button>
        </>) : (<>
          <Input label="UsuÃ¡rio" value={user} onChange={v=>{setUser(v);setErr("");}} required />
          <Input label="Senha" type="password" value={pass} onChange={v=>{setPass(v);setErr("");}} required error={err} />
          <Btn block onClick={doLogin}>Entrar</Btn>
          <button onClick={()=>{setIsReg(true);setErr("");}} style={{display:"block",margin:"6px auto 0",background:"none",border:"none",color:T.accent,fontSize:11,cursor:"pointer"}}>Cadastre-se</button>
        </>)}
      </Card>
    </div>
  );
}

function OrgPanel({ org, toast, config }) {
  const mob = useIsMobile();
  const [tab, setTab] = useState("dash");
  const [rifas, setRifas] = useState([]);
  const [loading, setLoading] = useState(true);

  const loadRifas = async () => { try { setLoading(true); const r = await sb.query("rifas", { filter: `&organizer_id=eq.${org.id}`, order: "created_at.desc" }); setRifas(r); } catch(e){} finally { setLoading(false); } };
  useEffect(() => { loadRifas(); }, []);

  const tabs = [{id:"dash",l:"ğŸ“Š Painel"},{id:"create",l:"â• Rifa"},{id:"manage",l:"ğŸ¯ Gerenciar"},{id:"draw",l:"ğŸ† Sorteio"}];

  return (
    <div>
      <div style={{background:`linear-gradient(135deg,${T.bg},#12182d)`,borderBottom:`1px solid ${T.bdr}`,position:"sticky",top:0,zIndex:100}}>
        <div style={{maxWidth:960,margin:"0 auto",padding:"8px 14px"}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}><div><h1 style={{margin:0,fontSize:14,fontWeight:800,color:T.gold}}>Rifas Online</h1><p style={{margin:0,fontSize:9,color:T.mut}}>ğŸ‘¤ {org.name}</p></div></div>
          <nav style={{display:"flex",gap:2,marginTop:5,overflowX:"auto"}}>{tabs.map(t => <button key={t.id} onClick={()=>setTab(t.id)} style={{padding:"4px 8px",border:"none",borderRadius:"4px 4px 0 0",background:tab===t.id?T.gold+"18":"transparent",color:tab===t.id?T.gold:T.mut,fontSize:10,fontWeight:tab===t.id?700:500,cursor:"pointer",borderBottom:tab===t.id?`2px solid ${T.gold}`:"2px solid transparent"}}>{t.l}</button>)}</nav>
        </div>
      </div>
      <div style={{maxWidth:960,margin:"0 auto",padding:mob?"10px 10px 30px":"12px 16px 30px"}}>
        {loading ? <Loading /> : <>
          {tab === "dash" && <OrgDash rifas={rifas} setTab={setTab} config={config} />}
          {tab === "create" && <OrgCreate org={org} toast={toast} config={config} onCreated={()=>{loadRifas();setTab("dash");}} />}
          {tab === "manage" && <OrgManage rifas={rifas} toast={toast} onUpdate={loadRifas} />}
          {tab === "draw" && <OrgDrawTab rifas={rifas} />}
        </>}
      </div>
    </div>
  );
}

function OrgDash({ rifas, setTab, config }) {
  if (!rifas.length) return <Card><div style={{textAlign:"center",padding:"30px 16px"}}><div style={{fontSize:40}}>ğŸŸï¸</div><h2 style={{color:T.txt,fontSize:15,fontWeight:800,margin:"6px 0"}}>Crie sua primeira rifa!</h2><Btn onClick={()=>setTab("create")}>â• Criar</Btn></div></Card>;
  return (
    <div style={{display:"flex",flexDirection:"column",gap:10}}>
      {rifas.map(r => (
        <Card key={r.id} title={<span><span style={{padding:"1px 5px",borderRadius:3,background:T.purp+"22",color:T.purp,fontSize:9,fontWeight:800,fontFamily:"monospace",marginRight:5}}>{r.code}</span>{r.rifa_name}</span>} subtitle={`ğŸ† ${r.prize} â€¢ ${r.status==="pending_fee"?"â³ Aguardando tarifa":r.status==="active"?"ğŸŸ¢ Ativa":"ğŸ”´ Inativa"}`}>
          {r.status === "pending_fee" && config && (
            <div style={{padding:10,borderRadius:8,background:T.warn+"11",border:`1px solid ${T.warn}44`}}>
              <div style={{fontSize:12,color:T.warn,fontWeight:700,marginBottom:6}}>â³ Pague a tarifa para ativar</div>
              <div style={{background:T.bg,borderRadius:8,padding:10,textAlign:"center",marginBottom:6}}>
                <div style={{fontSize:9,color:T.mut}}>Tarifa ({r.fee_percent}%)</div>
                <div style={{fontSize:20,fontWeight:900,color:T.gold,fontFamily:"monospace"}}>{fmt(r.fee_amount)}</div>
              </div>
              {config.pix_key ? (
                <div style={{background:T.bg,borderRadius:8,padding:10,border:`1px solid ${T.accent}22`,textAlign:"center"}}>
                  <div style={{fontSize:9,color:T.mut}}>PIX para pagamento</div>
                  <div style={{fontSize:15,fontWeight:800,color:T.accent,fontFamily:"monospace",wordBreak:"break-all",margin:"3px 0"}}>{config.pix_key}</div>
                  {config.pix_name && <div style={{fontSize:10,color:T.mut}}>Titular: {config.pix_name}</div>}
                  <button onClick={()=>{navigator.clipboard.writeText(config.pix_key).then(()=>alert("ğŸ“‹ Copiado!"));}} style={{marginTop:4,padding:"3px 8px",borderRadius:4,border:`1px solid ${T.accent}44`,background:T.accent+"11",color:T.accent,fontSize:9,fontWeight:600,cursor:"pointer"}}>ğŸ“‹ Copiar PIX</button>
                </div>
              ) : <div style={{fontSize:10,color:T.err}}>âš ï¸ PIX admin nÃ£o configurado</div>}
            </div>
          )}
        </Card>
      ))}
    </div>
  );
}

function OrgCreate({ org, toast, config, onCreated }) {
  const [c,setC] = useState({rifa_name:"",prize:"",prize_value:"",total_numbers:100,price_per_number:10,draw_date:"",description:""});
  const [saving,setSaving] = useState(false);
  const u = (k,v) => setC(p=>({...p,[k]:v}));
  const fp = config?.fee_percent || 5;
  const rev = c.total_numbers * c.price_per_number;
  const fee = rev * fp / 100;

  const create = async () => {
    if (!c.rifa_name || !c.prize) { toast("Preencha nome e prÃªmio!", "err"); return; }
    setSaving(true);
    try {
      await sb.insert("rifas", {
        code: genCode(), organizer_id: org.id, organizer_name: org.name,
        rifa_name: c.rifa_name, prize: c.prize, prize_value: parseFloat(c.prize_value)||0,
        total_numbers: c.total_numbers, price_per_number: c.price_per_number,
        draw_date: c.draw_date || null, description: c.description,
        pix_key: org.pix_key, pix_name: org.name,
        fee_percent: fp, fee_amount: fee,
      });
      toast("âœ… Rifa criada! Pague a tarifa para ativar.", "ok");
      onCreated();
    } catch(e) { toast("Erro: " + e.message, "err"); } finally { setSaving(false); }
  };

  return (
    <Card title="â• Nova Rifa">
      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"0 12px"}}>
        <div style={{gridColumn:"1/-1"}}><Input label="Nome" value={c.rifa_name} onChange={v=>u("rifa_name",v)} required /></div>
        <Input label="PrÃªmio" value={c.prize} onChange={v=>u("prize",v)} required />
        <Input label="Valor PrÃªmio" type="number" value={c.prize_value} onChange={v=>u("prize_value",v)} prefix="R$" />
        <Input label="Qtd NÃºmeros" type="number" value={c.total_numbers} onChange={v=>u("total_numbers",parseInt(v)||0)} />
        <Input label="PreÃ§o/NÂº" type="number" value={c.price_per_number} onChange={v=>u("price_per_number",parseFloat(v)||0)} prefix="R$" />
        <Input label="Data Sorteio" type="date" value={c.draw_date} onChange={v=>u("draw_date",v)} />
        <div style={{gridColumn:"1/-1"}}><Input label="DescriÃ§Ã£o" value={c.description} onChange={v=>u("description",v)} textarea /></div>
      </div>
      <div style={{padding:8,borderRadius:6,background:T.purp+"0d",border:`1px solid ${T.purp}22`,marginBottom:8}}>
        <div style={{fontSize:10,fontWeight:700,color:T.purp}}>ğŸ’ Tarifa ({fp}%): {fmt(fee)}</div>
        <div style={{fontSize:9,color:T.mut}}>Lucro estimado: {fmt(rev - (parseFloat(c.prize_value)||0) - fee)}</div>
      </div>
      <Btn block onClick={create} disabled={saving}>{saving ? "Criando..." : `ğŸŸï¸ Criar Rifa (${fmt(fee)} tarifa)`}</Btn>
    </Card>
  );
}

function OrgManage({ rifas, toast, onUpdate }) {
  const [selId,setSelId] = useState(null);
  const [nums,setNums] = useState([]);
  const [search,setSearch] = useState("");
  const rifa = rifas.find(r=>r.id===selId);

  const loadNums = async (id) => { const n = await sb.query("numbers", { filter: `&rifa_id=eq.${id}`, order: "number.asc" }); setNums(n); };

  useEffect(() => { if (selId) loadNums(selId); }, [selId]);

  if (!rifa) return (
    <Card title="ğŸ¯ Suas Rifas">{rifas.filter(r=>r.status==="active").length === 0 ? <p style={{color:T.mut,fontSize:12}}>Nenhuma rifa ativa.</p> : rifas.filter(r=>r.status==="active").map(r => (
      <div key={r.id} onClick={()=>setSelId(r.id)} style={{padding:8,borderRadius:6,background:T.inp,border:`1px solid ${T.bdr}`,marginBottom:4,cursor:"pointer"}}><div style={{fontSize:12,fontWeight:700,color:T.txt}}><span style={{color:T.purp,fontSize:9,marginRight:4}}>{r.code}</span>{r.rifa_name}</div></div>
    ))}</Card>
  );

  const buyers = {};
  nums.forEach(n => { if(!n.buyer_name)return; const k = n.purchase_id||n.buyer_name; if(!buyers[k]) buyers[k] = {name:n.buyer_name,phone:n.buyer_phone,key:k,numbers:[],tp:0,tpd:0}; buyers[k].numbers.push(n); if(n.paid) buyers[k].tp+=rifa.price_per_number; else buyers[k].tpd+=rifa.price_per_number; });
  let list = Object.values(buyers).filter(b => !search || b.name.toLowerCase().includes(search.toLowerCase()));
  const pad = rifa.total_numbers > 99 ? 3 : 2;

  const togglePay = async (numId, paid) => {
    try { await sb.update("numbers", `id=eq.${numId}`, { paid: !paid }); await loadNums(selId); toast(paid?"â³ Desmarcado":"âœ… Pago!","ok"); } catch(e) { toast("Erro","err"); }
  };
  const markAll = async (k) => {
    const b = buyers[k]; for (const n of b.numbers) { if(!n.paid) await sb.update("numbers", `id=eq.${n.id}`, { paid: true }); }
    await loadNums(selId); toast("âœ… Todos pagos!","ok");
  };

  return (
    <div style={{display:"flex",flexDirection:"column",gap:8}}>
      <div style={{display:"flex",gap:4,alignItems:"center"}}><Btn variant="ghost" size="sm" onClick={()=>setSelId(null)}>â† Voltar</Btn><h3 style={{margin:0,fontSize:13,color:T.txt}}>{rifa.code} â€” {rifa.rifa_name}</h3></div>
      <Card title="ğŸ‘¥ Compradores" subtitle={`${list.length}`}>
        <input type="text" placeholder="ğŸ” Buscar..." value={search} onChange={e=>setSearch(e.target.value)} style={{width:"100%",padding:"5px 8px",borderRadius:5,border:`1px solid ${T.bdr}`,background:T.inp,color:T.txt,fontSize:11,marginBottom:6,boxSizing:"border-box"}} />
        <div style={{display:"flex",flexDirection:"column",gap:4,maxHeight:380,overflowY:"auto"}}>
          {list.map(b => (
            <div key={b.key} style={{padding:6,borderRadius:5,background:T.inp,border:`1px solid ${b.tpd>0?T.warn+"33":T.ok+"33"}`}}>
              <div style={{display:"flex",justifyContent:"space-between",marginBottom:2}}><div><div style={{fontSize:11,fontWeight:700,color:T.txt}}>{b.name}</div><div style={{fontSize:9,color:T.mut}}>{b.phone||"â€”"}</div></div><div style={{fontSize:10,fontWeight:700,color:b.tpd>0?T.warn:T.ok}}>{b.tpd>0?`â³ ${fmt(b.tpd)}`:"âœ…"}</div></div>
              <div style={{display:"flex",flexWrap:"wrap",gap:2,marginBottom:3}}>{b.numbers.map(n => <button key={n.id} onClick={()=>togglePay(n.id,n.paid)} style={{padding:"1px 4px",borderRadius:3,background:n.paid?T.ok+"22":T.warn+"22",border:`1px solid ${n.paid?T.ok+"44":T.warn+"44"}`,color:n.paid?T.ok:T.warn,fontSize:9,fontWeight:700,fontFamily:"monospace",cursor:"pointer"}}>{String(n.number).padStart(pad,"0")} {n.paid?"âœ…":"â³"}</button>)}</div>
              {b.tpd>0 && <Btn variant="success" size="sm" onClick={()=>markAll(b.key)}>ğŸ’° Pagar tudo</Btn>}
            </div>
          ))}
          {!list.length && <div style={{textAlign:"center",padding:12,color:T.mut,fontSize:11}}>Nenhum comprador</div>}
        </div>
      </Card>
    </div>
  );
}

function OrgDrawTab({ rifas }) {
  const [selId,setSelId] = useState(null);
  const [nums,setNums] = useState([]);
  const [winner,setWinner] = useState(null);const [drawing,setDrawing] = useState(false);const [anim,setAnim] = useState(null);
  const rifa = rifas.find(r=>r.id===selId);

  useEffect(() => { if(selId) sb.query("numbers",{filter:`&rifa_id=eq.${selId}&paid=eq.true`}).then(setNums); }, [selId]);

  if(!rifa) return <Card title="ğŸ† Sorteio">{rifas.filter(r=>r.status==="active").map(r => <div key={r.id} onClick={()=>setSelId(r.id)} style={{padding:6,borderRadius:5,background:T.inp,border:`1px solid ${T.bdr}`,marginBottom:3,cursor:"pointer"}}><div style={{fontSize:11,fontWeight:700,color:T.txt}}>{r.code} â€” {r.rifa_name}</div></div>)}</Card>;

  const draw = () => {
    if(nums.length<2) return; setDrawing(true); setWinner(null); let c=0;
    const iv = setInterval(()=>{setAnim(nums[secureRandom(nums.length)].number);c++;if(c>30){clearInterval(iv);const x=nums[secureRandom(nums.length)];setAnim(x.number);setWinner(x);setDrawing(false);}},80);
  };

  return (
    <Card title={`ğŸ† ${rifa.rifa_name}`} headerRight={<Btn variant="ghost" size="sm" onClick={()=>{setSelId(null);setWinner(null);setAnim(null);}}>â† Voltar</Btn>}>
      <div style={{textAlign:"center",padding:"10px 0"}}>
        <div style={{width:70,height:70,borderRadius:"50%",margin:"0 auto 10px",background:winner?`linear-gradient(135deg,${T.gold},#b8860b)`:T.inp,border:`3px solid ${winner?T.gold:T.bdr}`,display:"flex",alignItems:"center",justifyContent:"center"}}>
          <span style={{fontSize:anim?28:14,fontWeight:900,fontFamily:"monospace",color:winner?T.bg:drawing?T.accent:T.mut}}>{anim?String(anim).padStart(2,"0"):"?"}</span>
        </div>
        {winner && <div style={{padding:8,borderRadius:8,background:T.gold+"0d",border:`1px solid ${T.gold}33`,marginBottom:8}}><div style={{fontSize:10,color:T.gold,fontWeight:700}}>ğŸ‰ GANHADOR!</div><div style={{fontSize:15,fontWeight:800,color:T.txt}}>{winner.buyer_name}</div><div style={{fontSize:10,color:T.mut}}>NÂº {String(winner.number).padStart(2,"0")} â€¢ {winner.buyer_phone||""}</div></div>}
        <Btn onClick={draw} disabled={drawing||nums.length<2}>{drawing?"ğŸ°...":winner?"ğŸ”„ Novo":"ğŸ° Sortear"}</Btn>
        <div style={{fontSize:10,color:T.mut,marginTop:4}}>{nums.length} nÂº pagos</div>
      </div>
    </Card>
  );
}

// ====== ADMIN PANEL ======
function AdminLogin({ onLogin, toast }) {
  const [u,setU] = useState("");const [p,setP] = useState("");const [err,setErr] = useState("");
  const [isSetup,setIsSetup] = useState(false);const [p2,setP2] = useState("");const [checking,setChecking] = useState(true);
  const [pixKey,setPixKey] = useState("");const [pixName,setPixName] = useState("");

  useEffect(() => { sb.query("platform_config").then(r => { setIsSetup(!r.length); setChecking(false); }).catch(()=>setChecking(false)); }, []);

  const doSetup = async () => {
    if (!u.trim() || p.length < 6) { setErr("UsuÃ¡rio e senha (mÃ­n 6)"); return; }
    if (p !== p2) { setErr("Senhas nÃ£o conferem"); return; }
    try {
      const h = await hashPass(p);
      await sb.insert("platform_config", { admin_user: u.trim().toLowerCase(), admin_hash: h, pix_key: pixKey, pix_name: pixName });
      toast("âœ… Admin configurado!", "ok");
      setIsSetup(false); setErr("");
    } catch(e) { setErr("Erro: " + e.message); }
  };

  const doLogin = async () => {
    try {
      const configs = await sb.query("platform_config");
      const cfg = configs[0];
      if (!cfg) { setErr("Admin nÃ£o configurado"); return; }
      if (u.trim().toLowerCase() !== cfg.admin_user) { setErr("Credenciais invÃ¡lidas"); return; }
      const h = await hashPass(p);
      if (h !== cfg.admin_hash) { setErr("Credenciais invÃ¡lidas"); return; }
      onLogin(cfg);
    } catch(e) { setErr("Erro: " + e.message); }
  };

  if (checking) return <Loading text="Verificando..." />;

  return (
    <div style={{display:"flex",alignItems:"center",justifyContent:"center",minHeight:"70vh",padding:16}}>
      <Card title={isSetup?"ğŸ›¡ï¸ Configurar Admin":"ğŸ›¡ï¸ Admin"} subtitle={isSetup?"Primeiro acesso":undefined} style={{maxWidth:380,width:"100%"}}>
        {isSetup ? (<>
          <Input label="UsuÃ¡rio Admin" value={u} onChange={v=>{setU(v);setErr("");}} required />
          <Input label="Senha (mÃ­n 6)" type="password" value={p} onChange={v=>{setP(v);setErr("");}} required />
          <Input label="Confirmar Senha" type="password" value={p2} onChange={v=>{setP2(v);setErr("");}} required />
          <Input label="Sua Chave PIX (para tarifas)" value={pixKey} onChange={setPixKey} placeholder="CPF, celular, e-mail..." />
          <Input label="Titular PIX" value={pixName} onChange={setPixName} />
          {err && <div style={{padding:3,borderRadius:4,marginBottom:4,background:T.err+"11",fontSize:10,color:T.err}}>{err}</div>}
          <Btn block onClick={doSetup}>ğŸ›¡ï¸ Criar Admin</Btn>
        </>) : (<>
          <Input label="UsuÃ¡rio" value={u} onChange={v=>{setU(v);setErr("");}} required />
          <Input label="Senha" type="password" value={p} onChange={v=>{setP(v);setErr("");}} required error={err} />
          <Btn block onClick={doLogin}>ğŸ›¡ï¸ Entrar</Btn>
        </>)}
      </Card>
    </div>
  );
}

function AdminPanel({ cfg, toast }) {
  const mob = useIsMobile();
  const [tab,setTab] = useState("dash");
  const [rifas,setRifas] = useState([]);const [orgs,setOrgs] = useState([]);const [loading,setLoading] = useState(true);

  const load = async () => { try { setLoading(true); const [r,o] = await Promise.all([sb.query("rifas",{order:"created_at.desc"}), sb.query("organizers",{order:"created_at.desc"})]); setRifas(r); setOrgs(o); } catch(e){} finally { setLoading(false); } };
  useEffect(() => { load(); }, []);

  const tabs = [{id:"dash",l:"ğŸ“Š Painel"},{id:"rifas",l:"ğŸŸï¸ Rifas"},{id:"orgs",l:"ğŸ‘¥ Organizadores"},{id:"fees",l:"ğŸ’ Tarifas"}];

  const totalFees = rifas.filter(r=>r.fee_paid).reduce((a,r)=>a+Number(r.fee_amount),0);
  const pendFees = rifas.filter(r=>!r.fee_paid).reduce((a,r)=>a+Number(r.fee_amount),0);

  return (
    <div>
      <div style={{background:`linear-gradient(135deg,${T.bg},#1a0a2e)`,borderBottom:`1px solid ${T.bdr}`,position:"sticky",top:0,zIndex:100}}>
        <div style={{maxWidth:960,margin:"0 auto",padding:"8px 14px"}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
            <h1 style={{margin:0,fontSize:14,fontWeight:800,color:T.purp}}>ğŸ›¡ï¸ ADMIN</h1>
            <div style={{display:"flex",gap:8}}><div style={{textAlign:"center"}}><div style={{fontSize:12,fontWeight:700,color:T.ok,fontFamily:"monospace"}}>{fmt(totalFees)}</div><div style={{fontSize:8,color:T.mut}}>Recebido</div></div><div style={{textAlign:"center"}}><div style={{fontSize:12,fontWeight:700,color:T.warn,fontFamily:"monospace"}}>{fmt(pendFees)}</div><div style={{fontSize:8,color:T.mut}}>Pendente</div></div></div>
          </div>
          <nav style={{display:"flex",gap:2,marginTop:5}}>{tabs.map(t => <button key={t.id} onClick={()=>setTab(t.id)} style={{padding:"4px 8px",border:"none",borderRadius:"4px 4px 0 0",background:tab===t.id?T.purp+"18":"transparent",color:tab===t.id?T.purp:T.mut,fontSize:10,fontWeight:tab===t.id?700:500,cursor:"pointer",borderBottom:tab===t.id?`2px solid ${T.purp}`:"2px solid transparent"}}>{t.l}</button>)}</nav>
        </div>
      </div>
      <div style={{maxWidth:960,margin:"0 auto",padding:mob?"10px 10px 30px":"12px 16px 30px"}}>
        {loading ? <Loading /> : <>
          {tab === "dash" && <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(100px,1fr))",gap:6}}>{[["Organizadores",orgs.length,"ğŸ‘¥",T.accent],["Rifas",rifas.length,"ğŸŸï¸",T.gold],["Ativas",rifas.filter(r=>r.status==="active").length,"ğŸŸ¢",T.ok],["Aguardando",rifas.filter(r=>r.status==="pending_fee").length,"â³",T.warn],["Taxas Receb.",fmt(totalFees),"ğŸ’",T.purp],["Taxas Pend.",fmt(pendFees),"â³",T.warn]].map(([l,v,i,c],idx) => <div key={idx} style={{padding:8,borderRadius:6,background:T.card,border:`1px solid ${T.bdr}`,textAlign:"center"}}><div style={{fontSize:12}}>{i}</div><div style={{fontSize:15,fontWeight:900,color:c,fontFamily:"monospace"}}>{v}</div><div style={{fontSize:8,color:T.mut}}>{l}</div></div>)}</div>}
          {tab === "rifas" && <AdminRifas rifas={rifas} orgs={orgs} toast={toast} reload={load} />}
          {tab === "orgs" && <AdminOrgs orgs={orgs} rifas={rifas} toast={toast} reload={load} />}
          {tab === "fees" && <AdminFeesTab cfg={cfg} toast={toast} />}
        </>}
      </div>
    </div>
  );
}

function AdminRifas({ rifas, orgs, toast, reload }) {
  const confirmFee = async (id) => {
    try { await sb.update("rifas", `id=eq.${id}`, { fee_paid: true, status: "active", fee_confirmed_at: new Date().toISOString() }); toast("âœ… Rifa ativada!", "ok"); reload(); } catch(e) { toast("Erro","err"); }
  };
  const deactivate = async (id) => {
    try { await sb.update("rifas", `id=eq.${id}`, { status: "inactive" }); toast("â¸ï¸ Desativada", "ok"); reload(); } catch(e) { toast("Erro","err"); }
  };
  const del = async (id) => {
    if (!confirm("EXCLUIR rifa?")) return;
    try { await sb.del("rifas", `id=eq.${id}`); toast("ğŸ—‘ï¸ ExcluÃ­da", "ok"); reload(); } catch(e) { toast("Erro","err"); }
  };

  return (
    <Card title="ğŸŸï¸ Rifas" subtitle={`${rifas.length} total`}>
      <div style={{display:"flex",flexDirection:"column",gap:5,maxHeight:460,overflowY:"auto"}}>
        {rifas.map(r => {
          const org = orgs.find(o=>o.id===r.organizer_id);
          return (
            <div key={r.id} style={{padding:8,borderRadius:6,background:T.inp,border:`1px solid ${r.status==="pending_fee"?T.warn+"44":r.status==="active"?T.ok+"33":T.err+"33"}`}}>
              <div style={{display:"flex",justifyContent:"space-between",flexWrap:"wrap",gap:3}}>
                <div>
                  <div style={{fontSize:12,fontWeight:700,color:T.txt}}><span style={{color:T.purp,fontSize:9,marginRight:3}}>{r.code}</span>{r.rifa_name}</div>
                  <div style={{fontSize:10,color:T.mut}}>ğŸ‘¤ {org?.name||"?"} â€¢ ğŸ† {r.prize}</div>
                  <div style={{fontSize:10,color:T.mut}}>ğŸ’ {fmt(r.fee_amount)} ({r.fee_percent}%) â€¢ {r.fee_paid?"âœ… Paga":"â³ Pendente"}</div>
                </div>
                <div style={{display:"flex",gap:2,alignItems:"start"}}>
                  {r.status==="pending_fee" && <Btn variant="success" size="sm" onClick={()=>confirmFee(r.id)}>âœ… Ativar</Btn>}
                  {r.status==="active" && <Btn variant="secondary" size="sm" onClick={()=>deactivate(r.id)}>â¸ï¸</Btn>}
                  <Btn variant="danger" size="sm" onClick={()=>del(r.id)}>ğŸ—‘ï¸</Btn>
                </div>
              </div>
            </div>
          );
        })}
      </div>
    </Card>
  );
}

function AdminOrgs({ orgs, rifas, toast, reload }) {
  const block = async (id, blocked) => {
    try { await sb.update("organizers", `id=eq.${id}`, { blocked: !blocked }); toast(blocked?"ğŸ”“ Desbloqueado":"ğŸ”’ Bloqueado","ok"); reload(); } catch(e) { toast("Erro","err"); }
  };
  const del = async (id) => {
    if (!confirm("EXCLUIR organizador e rifas?")) return;
    try { await sb.del("organizers", `id=eq.${id}`); toast("ğŸ—‘ï¸ ExcluÃ­do","ok"); reload(); } catch(e) { toast("Erro","err"); }
  };
  return (
    <Card title="ğŸ‘¥ Organizadores" subtitle={`${orgs.length}`}>
      <div style={{display:"flex",flexDirection:"column",gap:4,maxHeight:460,overflowY:"auto"}}>
        {orgs.map(o => {
          const oRifas = rifas.filter(r=>r.organizer_id===o.id);
          return (
            <div key={o.id} style={{padding:8,borderRadius:6,background:T.inp,border:`1px solid ${o.blocked?T.err+"33":T.bdr}`}}>
              <div style={{display:"flex",justifyContent:"space-between",flexWrap:"wrap",gap:3}}>
                <div><div style={{fontSize:12,fontWeight:700,color:o.blocked?T.err:T.txt}}>{o.name} {o.blocked&&"ğŸš«"}</div><div style={{fontSize:10,color:T.mut}}>@{o.username} â€¢ {o.phone} â€¢ {oRifas.length} rifa(s)</div></div>
                <div style={{display:"flex",gap:2}}><Btn variant={o.blocked?"success":"secondary"} size="sm" onClick={()=>block(o.id,o.blocked)}>{o.blocked?"ğŸ”“":"ğŸ”’"}</Btn><Btn variant="danger" size="sm" onClick={()=>del(o.id)}>ğŸ—‘ï¸</Btn></div>
              </div>
            </div>
          );
        })}
      </div>
    </Card>
  );
}

function AdminFeesTab({ cfg, toast }) {
  const [pct,setPct] = useState(cfg?.fee_percent || 5);
  const [pix,setPix] = useState(cfg?.pix_key || "");
  const [pixN,setPixN] = useState(cfg?.pix_name || "");
  return (
    <Card title="ğŸ’ Tarifas" subtitle="AlteraÃ§Ãµes valem sÃ³ para novas rifas">
      <div style={{padding:6,borderRadius:5,background:T.warn+"0d",border:`1px solid ${T.warn}22`,marginBottom:8}}>
        <div style={{fontSize:10,color:T.warn,fontWeight:700}}>âš ï¸ Rifas existentes mantÃªm taxa da criaÃ§Ã£o</div>
      </div>
      <Input label="Percentual (%)" type="number" value={pct} onChange={setPct} suffix="%" />
      <Input label="Chave PIX (para tarifas)" value={pix} onChange={setPix} />
      <Input label="Titular PIX" value={pixN} onChange={setPixN} />
      <Btn onClick={async () => {
        try {
          await sb.update("platform_config", `id=eq.${cfg.id}`, { fee_percent: parseFloat(pct)||5, pix_key: pix, pix_name: pixN });
          toast(`âœ… Tarifa: ${pct}%`, "ok");
        } catch(e) { toast("Erro","err"); }
      }}>ğŸ’¾ Salvar</Btn>
    </Card>
  );
}

// ====== MAIN APP ======
window.RifaApp = function App() {
  const mob = useIsMobile();
  const [mode, setMode] = useState("public");
  const [currentOrg, setCurrentOrg] = useState(null);
  const [adminCfg, setAdminCfg] = useState(null);
  const [config, setConfig] = useState(null);
  const [toast, showToast, hideToast] = useToast();

  // Load platform config on mount
  useEffect(() => { sb.query("platform_config").then(r => { if(r[0]) setConfig(r[0]); }).catch(()=>{}); }, []);

  return (
    <div style={{minHeight:"100vh",background:T.bg,color:T.txt,fontFamily:"'Segoe UI',-apple-system,sans-serif"}}>
      <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet" />
      <Toast msg={toast?.msg} type={toast?.type} onClose={hideToast} />

      {mode === "public" && <>
        <div style={{background:T.card,borderBottom:`1px solid ${T.bdr}`,padding:"8px 14px"}}>
          <div style={{maxWidth:780,margin:"0 auto",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
            <div style={{display:"flex",alignItems:"center",gap:6}}>
              <div style={{width:24,height:24,borderRadius:5,background:`linear-gradient(135deg,${T.gold},#b8860b)`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:11}}>ğŸŸï¸</div>
              <h1 style={{margin:0,fontSize:14,fontWeight:800,fontFamily:"'Playfair Display',Georgia,serif",background:`linear-gradient(90deg,${T.gold},${T.goldL})`,WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent"}}>Rifas Online</h1>
            </div>
            <div style={{display:"flex",gap:3}}>
              <button onClick={()=>setMode("org-login")} style={{background:"none",border:`1px solid ${T.bdr}`,borderRadius:4,color:T.mut,fontSize:9,padding:"3px 6px",cursor:"pointer"}}>ğŸ‘¤ Organizador</button>
              <button onClick={()=>setMode("admin-login")} style={{background:"none",border:`1px solid ${T.bdr}`,borderRadius:4,color:T.mut,fontSize:9,padding:"3px 6px",cursor:"pointer"}}>ğŸ›¡ï¸</button>
            </div>
          </div>
        </div>
        <PublicView toast={showToast} />
      </>}

      {mode === "org-login" && <>
        <div style={{padding:"4px 14px",textAlign:"center"}}><button onClick={()=>setMode("public")} style={{background:"none",border:"none",color:T.mut,fontSize:11,cursor:"pointer"}}>â† Voltar</button></div>
        <OrgLogin organizers={[]} onLogin={(org) => { setCurrentOrg(org); setMode("org"); }} onRegister={() => {}} toast={showToast} />
      </>}

      {mode === "org" && currentOrg && <>
        <div style={{textAlign:"right",padding:"3px 14px"}}><button onClick={()=>{setMode("public");setCurrentOrg(null);}} style={{background:"none",border:"none",color:T.mut,fontSize:10,cursor:"pointer"}}>ğŸšª Sair</button></div>
        <OrgPanel org={currentOrg} toast={showToast} config={config} />
      </>}

      {mode === "admin-login" && <>
        <div style={{padding:"4px 14px",textAlign:"center"}}><button onClick={()=>setMode("public")} style={{background:"none",border:"none",color:T.mut,fontSize:11,cursor:"pointer"}}>â† Voltar</button></div>
        <AdminLogin onLogin={(cfg) => { setAdminCfg(cfg); setMode("admin"); }} toast={showToast} />
      </>}

      {mode === "admin" && adminCfg && <>
        <div style={{textAlign:"right",padding:"3px 14px"}}><button onClick={()=>setMode("public")} style={{background:"none",border:"none",color:T.mut,fontSize:10,cursor:"pointer"}}>ğŸšª Sair</button></div>
        <AdminPanel cfg={adminCfg} toast={showToast} />
      </>}
    </div>
  );
};
  ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(window.RifaApp));
  </script>
</body>
</html>
