<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rifas Online</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸŸï¸</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',-apple-system,sans-serif;background:#0a0f1a;color:#E5E7EB}
    #root{min-height:100vh}
    ::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:#111827}::-webkit-scrollbar-thumb{background:#D4A843;border-radius:3px}
    ::selection{background:#D4A84366}
    @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
  </style>
</head>
<body>
<div id="root"><div style="display:flex;align-items:center;justify-content:center;min-height:100vh;color:#9CA3AF">ğŸŸï¸ Carregando...</div></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script type="text/babel">
const {useState, useEffect, useCallback} = React;

/* ==================== CONFIG ==================== */
const SB_URL = "https://qewbnvbqdqryaekicdae.supabase.co";
const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFld2JudmJxZHFyeWFla2ljZGFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwODg5MDIsImV4cCI6MjA4NjY2NDkwMn0.SMuE_GGVLtISBXhiV2o_OPZkEvGV_SIEfcT3Keqzrns";

const sb = {
  h: {"apikey":SB_KEY,"Authorization":`Bearer ${SB_KEY}`,"Content-Type":"application/json"},
  async rpc(fn, p={}) {
    const r = await fetch(`${SB_URL}/rest/v1/rpc/${fn}`, {method:"POST",headers:this.h,body:JSON.stringify(p)});
    if(!r.ok){const t=await r.text();console.error(`RPC ${fn}:`,t);throw new Error(t)}
    return r.json();
  }
};

/* ==================== THEME & UTILS ==================== */
const C = {bg:"#0a0f1a",card:"#111827",gold:"#D4A843",goldL:"#F5DEB3",accent:"#22D3EE",ok:"#34D399",warn:"#FBBF24",err:"#F87171",txt:"#E5E7EB",mut:"#9CA3AF",bdr:"#1E293B",inp:"#1a2332",purp:"#A78BFA"};
const fmt = v => new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(v);
function sRand(max){const a=new Uint32Array(4);crypto.getRandomValues(a);return((a[0]^a[1]^a[2]^a[3])>>>0)%max}
function genCode(){const ch="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";let s="RF-";for(let i=0;i<4;i++)s+=ch[sRand(ch.length)];return s}
function useMob(){const[m,s]=useState(window.innerWidth<768);useEffect(()=>{const h=()=>s(window.innerWidth<768);window.addEventListener("resize",h);return()=>window.removeEventListener("resize",h)},[]);return m}
function useToast(){const[t,s]=useState(null);return[t,(msg,tp="ok")=>{s({msg,tp});setTimeout(()=>s(null),3000)},()=>s(null)]}

/* ==================== UI ATOMS ==================== */
function Toast({t,onClose}){if(!t)return null;const bg=t.tp==="ok"?C.ok:t.tp==="err"?C.err:C.warn;return<div onClick={onClose} style={{position:"fixed",top:16,left:"50%",transform:"translateX(-50%)",padding:"8px 18px",borderRadius:8,background:bg,color:"#fff",fontSize:12,fontWeight:700,zIndex:99999,cursor:"pointer",boxShadow:"0 4px 20px rgba(0,0,0,.3)"}}>{t.msg}</div>}
function Loading({text}){return<div style={{textAlign:"center",padding:40}}><div style={{fontSize:28,animation:"spin 1s linear infinite"}}>ğŸŸï¸</div><div style={{color:C.mut,fontSize:12,marginTop:8}}>{text||"Carregando..."}</div></div>}

function Inp({label,type="text",value,onChange,placeholder,prefix,error,required,textarea,suffix}){
  const Tag=textarea?"textarea":"input";
  return(<div style={{marginBottom:12}}>
    {label&&<label style={{display:"block",fontSize:11,fontWeight:600,color:error?C.err:C.mut,marginBottom:4,textTransform:"uppercase",letterSpacing:.5}}>{label}{required&&<span style={{color:C.err}}> *</span>}</label>}
    <div style={{position:"relative"}}>
      {prefix&&<span style={{position:"absolute",left:10,top:"50%",transform:"translateY(-50%)",color:C.mut,fontSize:13,pointerEvents:"none"}}>{prefix}</span>}
      <Tag type={type} value={value} onChange={e=>onChange(e.target.value)} placeholder={placeholder}
        style={{width:"100%",padding:textarea?"10px 12px":"9px 12px",paddingLeft:prefix?34:12,background:C.inp,border:`1px solid ${error?C.err:C.bdr}`,borderRadius:8,color:C.txt,fontSize:14,outline:"none",resize:textarea?"vertical":"none",minHeight:textarea?60:"auto",boxSizing:"border-box"}}
        onFocus={e=>{e.target.style.borderColor=C.gold}} onBlur={e=>{e.target.style.borderColor=error?C.err:C.bdr}} />
      {suffix&&<span style={{position:"absolute",right:10,top:"50%",transform:"translateY(-50%)",color:C.mut,fontSize:11}}>{suffix}</span>}
    </div>
    {error&&<span style={{fontSize:11,color:C.err,marginTop:2,display:"block"}}>{error}</span>}
  </div>)
}

function Btn({children,onClick,variant="primary",size="md",disabled,block,style:cs}){
  const vs={primary:{bg:C.gold,c:C.bg},secondary:{bg:C.bdr,c:C.txt},success:{bg:C.ok,c:C.bg},danger:{bg:"#DC2626",c:"#fff"},ghost:{bg:"transparent",c:C.mut},accent:{bg:C.accent,c:C.bg},purple:{bg:C.purp,c:"#fff"}};
  const sz={sm:{p:"5px 10px",f:11},md:{p:"9px 16px",f:13},lg:{p:"12px 24px",f:15}};
  const v=vs[variant]||vs.primary,s=sz[size]||sz.md;
  return<button onClick={onClick} disabled={disabled} style={{padding:s.p,border:"none",borderRadius:8,background:disabled?C.bdr:v.bg,color:disabled?C.mut:v.c,fontSize:s.f,fontWeight:700,cursor:disabled?"not-allowed":"pointer",opacity:disabled?.5:1,width:block?"100%":"auto",...cs}}>{children}</button>
}

function Card({children,title,subtitle,headerRight,style:cs}){
  return(<div style={{background:C.card,borderRadius:12,border:`1px solid ${C.bdr}`,overflow:"hidden",...cs}}>
    {title&&<div style={{padding:"12px 16px",borderBottom:`1px solid ${C.bdr}`,display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:6}}>
      <div><h3 style={{margin:0,fontSize:14,fontWeight:700,color:C.txt}}>{title}</h3>{subtitle&&<p style={{margin:"2px 0 0",fontSize:11,color:C.mut}}>{subtitle}</p>}</div>{headerRight}
    </div>}
    <div style={{padding:"12px 16px"}}>{children}</div>
  </div>)
}

/* ==================== RECEIPT MODAL ==================== */
function ReceiptModal({open,onClose,rifa,buyer,numbers}){
  if(!open||!rifa||!buyer)return null;
  const total=numbers.length*rifa.price_per_number;
  const pad=rifa.total_numbers>99?3:2;
  const txt=(wa)=>{const b=wa?"*":"";return[`ğŸŸï¸ ${b}Rifas Online${b}`,`${b}Rifa:${b} ${rifa.rifa_name}`,`${b}CÃ³digo:${b} ${rifa.code}`,`${b}PrÃªmio:${b} ${rifa.prize}`,`${b}Comprador:${b} ${buyer.name}`,`${b}NÃºmeros:${b} ${numbers.map(n=>String(n).padStart(pad,"0")).join(", ")}`,`${b}Total:${b} ${fmt(total)}`,`${b}Status:${b} â³ PENDENTE`,rifa.pix_key?`\n${b}PIX:${b} ${rifa.pix_key}\n${b}Valor:${b} ${fmt(total)}`:""].filter(Boolean).join("\n")};
  return(
    <div onClick={onClose} style={{position:"fixed",inset:0,background:"rgba(0,0,0,.75)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:99999,padding:10,backdropFilter:"blur(4px)"}}>
      <div onClick={e=>e.stopPropagation()} style={{background:"#fefbf3",borderRadius:14,width:"100%",maxWidth:460,maxHeight:"90vh",overflow:"auto",color:"#222"}}>
        <div style={{textAlign:"center",padding:"16px 16px 10px",borderBottom:"3px double #D4A843"}}>
          <div style={{fontSize:22}}>ğŸŸï¸</div>
          <h2 style={{margin:"2px 0",fontSize:15,fontWeight:800,color:"#1a1a3e",fontFamily:"Georgia,serif"}}>Rifas Online</h2>
          <div style={{padding:"2px 8px",borderRadius:4,background:"#A78BFA22",color:"#A78BFA",fontSize:10,fontWeight:800,fontFamily:"monospace",display:"inline-block"}}>{rifa.code}</div>
        </div>
        <div style={{padding:"10px 16px"}}>
          {[["Rifa",rifa.rifa_name],["PrÃªmio",rifa.prize],["Comprador",buyer.name],["Tel",buyer.phone||"â€”"],["Cotas",numbers.length],["Total",fmt(total)]].map(([l,v],i)=>
            <div key={i} style={{display:"flex",justifyContent:"space-between",padding:"4px 0",borderBottom:"1px dashed #e0d5c0",fontSize:12}}>
              <span style={{color:"#888"}}>{l}</span><span style={{fontWeight:l==="Total"?800:600,color:l==="Total"?"#D4A843":"#222"}}>{v}</span>
            </div>
          )}
          <div style={{display:"flex",flexWrap:"wrap",gap:3,justifyContent:"center",margin:"10px 0"}}>
            {numbers.map(n=><div key={n} style={{width:30,height:30,borderRadius:5,display:"flex",alignItems:"center",justifyContent:"center",fontWeight:700,fontSize:10,fontFamily:"monospace",background:"#fff3cd",color:"#856404",border:"2px solid #ffc107"}}>{String(n).padStart(pad,"0")}</div>)}
          </div>
          <div style={{textAlign:"center",padding:5,borderRadius:5,fontWeight:700,fontSize:11,background:"#fff3cd",color:"#856404"}}>â³ PENDENTE</div>
          {rifa.pix_key&&<div style={{background:"#f0f7ff",border:"1px solid #b3d4fc",borderRadius:6,padding:8,marginTop:8,textAlign:"center"}}>
            <div style={{fontSize:10,color:"#555"}}>PIX:</div>
            <div style={{fontSize:14,fontWeight:800,color:"#1a1a3e",wordBreak:"break-all",margin:"4px 0"}}>{rifa.pix_key}</div>
            <div style={{fontSize:11,fontWeight:700,marginTop:3}}>Valor: {fmt(total)}</div>
          </div>}
        </div>
        <div style={{display:"flex",gap:4,padding:"6px 14px 14px",justifyContent:"center",flexWrap:"wrap"}}>
          <button onClick={()=>{navigator.clipboard.writeText(txt(false)).then(()=>alert("ğŸ“‹ Copiado!"))}} style={{padding:"5px 10px",borderRadius:6,border:"none",background:"#D4A843",color:"#1a1a3e",fontWeight:700,fontSize:10,cursor:"pointer"}}>ğŸ“‹ Copiar</button>
          <button onClick={()=>{window.open(`https://wa.me/${(buyer.phone||"").replace(/\D/g,"")}?text=${encodeURIComponent(txt(true))}`,"_blank")}} style={{padding:"5px 10px",borderRadius:6,border:"none",background:"#25D366",color:"#fff",fontWeight:700,fontSize:10,cursor:"pointer"}}>ğŸ“± Zap</button>
          <button onClick={onClose} style={{padding:"5px 10px",borderRadius:6,border:"1px solid #ddd",background:"#fff",color:"#666",fontWeight:600,fontSize:10,cursor:"pointer"}}>Fechar</button>
        </div>
      </div>
    </div>
  )
}

/* ==================== PUBLIC VIEW ==================== */
function PublicView({toast}){
  const mob=useMob();
  const[rifas,setRifas]=useState([]);const[loading,setLoading]=useState(true);
  const[selRifa,setSelRifa]=useState(null);const[nums,setNums]=useState([]);const[sel,setSel]=useState([]);
  const[name,setName]=useState("");const[phone,setPhone]=useState("");const[email,setEmail]=useState("");
  const[errs,setErrs]=useState({});const[step,setStep]=useState("list");const[done,setDone]=useState(null);
  const[ns,setNs]=useState("");const[rifaSearch,setRifaSearch]=useState("");const[receipt,setReceipt]=useState(null);const[buying,setBuying]=useState(false);

  useEffect(()=>{sb.rpc("get_active_rifas").then(r=>setRifas(Array.isArray(r)?r:[])).catch(()=>{}).finally(()=>setLoading(false))},[]);

  const loadNums=async(id)=>{try{const n=await sb.rpc("get_rifa_numbers",{p_rifa_id:id});setNums(Array.isArray(n)?n:[])}catch(e){console.error(e)}};
  const selectRifa=async(r)=>{setSelRifa(r);setStep("select");setSel([]);setNs("");await loadNums(r.id)};

  const validate=()=>{
    const e={};
    if(!name.trim())e.name="Nome obrigatÃ³rio";
    if(!phone.trim())e.phone="WhatsApp obrigatÃ³rio";
    else if(phone.replace(/\D/g,"").length<10)e.phone="MÃ­n 10 dÃ­gitos";
    if(email&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email))e.email="E-mail invÃ¡lido";
    if(!sel.length)e.numbers="Selecione nÃºmeros";
    setErrs(e);return!Object.keys(e).length;
  };

  const doBuy=async()=>{
    setBuying(true);
    try{
      const r=await sb.rpc("buy_numbers",{p_rifa_id:selRifa.id,p_numbers:sel,p_buyer_name:name.trim(),p_buyer_phone:phone.trim(),p_buyer_email:email.trim()});
      if(r.error){toast(r.error,"err");setBuying(false);return}
      setDone({buyer:{name:name.trim(),phone:phone.trim()},numbers:sel,total:sel.length*selRifa.price_per_number});
      setStep("pix");toast("âœ… NÃºmeros reservados!","ok");
    }catch(e){toast(e.message||"Erro ao reservar","err")}finally{setBuying(false)}
  };

  const filtered=rifas.filter(r=>{if(!rifaSearch)return true;const s=rifaSearch.toUpperCase();return(r.code||"").includes(s)||r.rifa_name.toLowerCase().includes(rifaSearch.toLowerCase())});

  if(loading)return<Loading text="Carregando rifas..."/>;

  /* PIX DONE */
  if(step==="pix"&&done){
    return(<div style={{maxWidth:460,margin:"0 auto",padding:mob?"14px 10px":"20px"}}>
      <Card><div style={{textAlign:"center"}}>
        <div style={{fontSize:40}}>âœ…</div>
        <h2 style={{color:C.ok,fontSize:17,fontWeight:800,marginBottom:4}}>Reservado!</h2>
        <p style={{color:C.mut,fontSize:11,marginBottom:10}}>Realize o PIX para confirmar.</p>
        {selRifa.pix_key&&<div style={{background:C.inp,borderRadius:10,padding:12,border:`2px dashed ${C.gold}44`,marginBottom:10}}>
          <div style={{fontSize:9,color:C.mut,textTransform:"uppercase",letterSpacing:1}}>Chave PIX</div>
          <div style={{fontSize:16,fontWeight:800,color:C.gold,fontFamily:"monospace",wordBreak:"break-all",margin:"4px 0"}}>{selRifa.pix_key}</div>
          <div style={{fontSize:10,color:C.mut}}>Titular: {selRifa.pix_name}</div>
          <div style={{marginTop:8,padding:6,background:C.warn+"11",borderRadius:5}}><div style={{fontSize:22,fontWeight:900,color:C.gold}}>{fmt(done.total)}</div></div>
          <button onClick={()=>{navigator.clipboard.writeText(selRifa.pix_key).then(()=>toast("ğŸ“‹ PIX copiado!","ok"))}} style={{marginTop:6,padding:"4px 10px",borderRadius:5,border:`1px solid ${C.accent}44`,background:C.accent+"11",color:C.accent,fontSize:10,fontWeight:600,cursor:"pointer"}}>ğŸ“‹ Copiar PIX</button>
        </div>}
        <div style={{display:"flex",gap:5,justifyContent:"center",flexWrap:"wrap"}}>
          <Btn variant="success" size="sm" onClick={()=>setReceipt({rifa:selRifa,buyer:done.buyer,numbers:done.numbers})}>ğŸ–¨ï¸ Comprovante</Btn>
          <Btn variant="secondary" size="sm" onClick={()=>{setStep("list");setSelRifa(null);setSel([]);setDone(null);setName("");setPhone("");setEmail("")}}>â† Rifas</Btn>
        </div>
      </div></Card>
      <ReceiptModal open={!!receipt} onClose={()=>setReceipt(null)} rifa={receipt?.rifa} buyer={receipt?.buyer} numbers={receipt?.numbers}/>
    </div>)
  }

  /* CONFIRM */
  if(step==="confirm"){
    const pad=selRifa.total_numbers>99?3:2,total=sel.length*selRifa.price_per_number;
    return(<div style={{maxWidth:460,margin:"0 auto",padding:mob?"14px 10px":"20px"}}>
      <Card title="ğŸ“‹ Confirme">
        <div style={{marginBottom:8}}><div style={{fontSize:11,color:C.mut}}>Comprador</div><div style={{fontSize:14,fontWeight:700}}>{name}</div><div style={{fontSize:11,color:C.mut}}>{phone}</div></div>
        <div style={{marginBottom:8}}><div style={{fontSize:11,color:C.mut}}>NÃºmeros ({sel.length})</div>
          <div style={{display:"flex",flexWrap:"wrap",gap:3}}>{sel.sort((a,b)=>a-b).map(n=><span key={n} style={{padding:"2px 6px",borderRadius:4,background:C.gold+"22",color:C.gold,fontSize:11,fontWeight:700,fontFamily:"monospace"}}>{String(n).padStart(pad,"0")}</span>)}</div>
        </div>
        <div style={{padding:8,borderRadius:8,background:C.gold+"11",textAlign:"center",marginBottom:8}}><div style={{fontSize:22,fontWeight:900,color:C.gold}}>{fmt(total)}</div></div>
        <div style={{display:"flex",gap:6}}><Btn variant="ghost" onClick={()=>setStep("select")}>â† Voltar</Btn><Btn block onClick={doBuy} disabled={buying}>{buying?"Reservando...":"âœ… Confirmar"}</Btn></div>
      </Card>
    </div>)
  }

  /* SELECT NUMBERS */
  if(step==="select"&&selRifa){
    const pad=selRifa.total_numbers>99?3:2;
    const sold=nums.filter(n=>n.is_taken).length,avail=selRifa.total_numbers-sold;
    const prog=(sold/selRifa.total_numbers)*100,total=sel.length*selRifa.price_per_number;
    const fNums=nums.filter(n=>!ns||n.number.toString().includes(ns));
    const sNum=ns?parseInt(ns):null;
    const toggle=n=>{if(nums.find(x=>x.number===n)?.is_taken)return;setSel(p=>p.includes(n)?p.filter(x=>x!==n):[...p,n])};

    return(<div style={{maxWidth:760,margin:"0 auto",padding:mob?"12px 10px":"18px"}}>
      <button onClick={()=>{setStep("list");setSelRifa(null);setSel([])}} style={{background:"none",border:"none",color:C.mut,fontSize:11,cursor:"pointer",marginBottom:6}}>â† Voltar</button>
      <div style={{textAlign:"center",marginBottom:12,padding:mob?"12px 10px":"18px 14px",background:`linear-gradient(135deg,${C.card},#0d1321)`,borderRadius:12,border:`1px solid ${C.bdr}`}}>
        <div style={{display:"inline-block",padding:"2px 8px",borderRadius:4,background:C.purp+"22",color:C.purp,fontSize:11,fontWeight:800,fontFamily:"monospace"}}>{selRifa.code}</div>
        <h1 style={{fontSize:mob?17:20,fontWeight:800,fontFamily:"'Playfair Display',Georgia,serif",margin:"4px 0"}}>{selRifa.rifa_name}</h1>
        <p style={{fontSize:12,color:C.gold,fontWeight:600}}>ğŸ† {selRifa.prize}</p>
        <div style={{display:"flex",justifyContent:"center",gap:mob?12:20,marginTop:8,flexWrap:"wrap"}}>
          <div><div style={{fontSize:16,fontWeight:900,color:C.gold,fontFamily:"monospace"}}>{fmt(selRifa.price_per_number)}</div><div style={{fontSize:8,color:C.mut}}>POR NÂº</div></div>
          <div><div style={{fontSize:16,fontWeight:900,color:C.accent,fontFamily:"monospace"}}>{avail}</div><div style={{fontSize:8,color:C.mut}}>LIVRES</div></div>
        </div>
        <div style={{margin:"6px auto 0",maxWidth:300,height:4,background:C.bdr,borderRadius:2,overflow:"hidden"}}><div style={{width:`${prog}%`,height:"100%",background:`linear-gradient(90deg,${C.gold},${C.ok})`,borderRadius:2}}/></div>
      </div>
      <div style={{display:"grid",gridTemplateColumns:mob?"1fr":"1.5fr 1fr",gap:12}}>
        <Card title="Escolha nÃºmeros" subtitle={sel.length?`${sel.length} selecionado(s)`:undefined}>
          <NumSearch value={ns} onChange={setNs} total={selRifa.total_numbers}/>
          <div style={{display:"grid",gridTemplateColumns:`repeat(auto-fill,minmax(${mob?32:36}px,1fr))`,gap:3,maxHeight:mob?230:340,overflowY:"auto"}}>
            {fNums.map(n=>{
              const s=sel.includes(n.number),tk=n.is_taken,sr=sNum===n.number;
              let bg=C.inp,cl=C.txt,b=C.bdr;
              if(tk){bg=C.mut+"15";cl=C.mut+"66";b="transparent"}else if(s){bg=C.gold+"33";cl=C.gold;b=C.gold}
              if(sr&&!tk&&!s){bg=C.accent+"22";cl=C.accent;b=C.accent}
              return<button key={n.number} onClick={()=>toggle(n.number)} disabled={tk} style={{width:"100%",aspectRatio:"1",display:"flex",alignItems:"center",justifyContent:"center",borderRadius:4,border:`1.5px solid ${b}`,background:bg,color:cl,fontSize:9,fontWeight:700,fontFamily:"monospace",cursor:tk?"not-allowed":"pointer",textDecoration:tk?"line-through":"none"}}>{String(n.number).padStart(pad,"0")}</button>
            })}
          </div>
        </Card>
        <Card title="ğŸ“ Seus Dados">
          {sel.length>0?<div style={{padding:5,borderRadius:6,marginBottom:6,background:C.gold+"11",textAlign:"center"}}><div style={{fontSize:18,fontWeight:900,color:C.gold}}>{fmt(total)}</div></div>
          :<div style={{padding:6,borderRadius:6,marginBottom:6,background:C.accent+"0d",textAlign:"center"}}><div style={{fontSize:10,color:C.accent}}>{mob?"â˜ï¸ Selecione acima":"ğŸ‘ˆ Selecione ao lado"}</div></div>}
          <Inp label="Nome" value={name} onChange={v=>{setName(v);if(errs.name)setErrs(p=>({...p,name:""}))}} placeholder="Seu nome" required error={errs.name}/>
          <Inp label="WhatsApp" value={phone} onChange={v=>{setPhone(v);if(errs.phone)setErrs(p=>({...p,phone:""}))}} placeholder="(88) 99999-0000" required error={errs.phone}/>
          <Inp label="E-mail (opcional)" value={email} onChange={v=>{setEmail(v);if(errs.email)setErrs(p=>({...p,email:""}))}} error={errs.email}/>
          <Btn block onClick={()=>{if(validate())setStep("confirm")}}>{sel.length===0?"Selecione nÃºmeros":`Continuar â†’ ${fmt(total)}`}</Btn>
          {sel.length>0&&<Btn variant="ghost" block onClick={()=>setSel([])} size="sm" style={{marginTop:3}}>Limpar</Btn>}
        </Card>
      </div>
    </div>)
  }

  /* RIFA LIST */
  return(<div style={{maxWidth:680,margin:"0 auto",padding:mob?"14px 10px":"22px 18px"}}>
    {rifas.length===0?
      <div style={{textAlign:"center",padding:"50px 16px"}}><div style={{fontSize:44}}>ğŸŸï¸</div><h2 style={{fontSize:17,fontWeight:700,fontFamily:"'Playfair Display',Georgia,serif"}}>Nenhuma rifa ativa</h2><p style={{color:C.mut,fontSize:12,marginTop:4}}>Volte em breve!</p></div>
    :<div style={{display:"flex",flexDirection:"column",gap:10}}>
      <h2 style={{fontSize:17,fontWeight:800,fontFamily:"'Playfair Display',Georgia,serif",textAlign:"center",margin:0}}>ğŸŸï¸ Rifas DisponÃ­veis</h2>
      <div style={{position:"relative"}}><span style={{position:"absolute",left:10,top:"50%",transform:"translateY(-50%)",fontSize:13}}>ğŸ”</span><input type="text" value={rifaSearch} onChange={e=>setRifaSearch(e.target.value)} placeholder="Buscar..." style={{width:"100%",padding:"8px 12px 8px 30px",borderRadius:8,border:`1px solid ${C.bdr}`,background:C.inp,color:C.txt,fontSize:12,boxSizing:"border-box",outline:"none"}}/></div>
      {filtered.map(r=>(
        <div key={r.id} onClick={()=>selectRifa(r)} style={{padding:14,borderRadius:10,background:C.card,border:`1px solid ${C.bdr}`,cursor:"pointer"}} onMouseEnter={e=>{e.currentTarget.style.borderColor=C.gold}} onMouseLeave={e=>{e.currentTarget.style.borderColor=C.bdr}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:6}}>
            <div>
              <div style={{display:"flex",alignItems:"center",gap:5}}><span style={{padding:"2px 5px",borderRadius:3,background:C.purp+"22",color:C.purp,fontSize:10,fontWeight:800,fontFamily:"monospace"}}>{r.code}</span><h3 style={{margin:0,fontSize:15,fontWeight:700}}>{r.rifa_name}</h3></div>
              <p style={{margin:"2px 0",fontSize:12,color:C.gold}}>ğŸ† {r.prize}</p>
              {r.description&&<p style={{margin:"3px 0 0",fontSize:11,color:C.mut}}>{r.description}</p>}
            </div>
            <div style={{textAlign:"right"}}><div style={{fontSize:17,fontWeight:900,color:C.gold,fontFamily:"monospace"}}>{fmt(r.price_per_number)}</div><div style={{fontSize:10,color:C.mut}}>{r.total_numbers} nÃºmeros</div></div>
          </div>
        </div>
      ))}
      {!filtered.length&&<div style={{textAlign:"center",padding:16,color:C.mut}}>Nenhuma rifa encontrada</div>}
    </div>}
  </div>)
}

function NumSearch({value,onChange,total}){
  return(<div style={{position:"relative",marginBottom:8}}><span style={{position:"absolute",left:10,top:"50%",transform:"translateY(-50%)",fontSize:13}}>ğŸ”</span><input type="text" value={value} onChange={e=>onChange(e.target.value)} placeholder={`Buscar nÂº (1-${total})...`} style={{width:"100%",padding:"8px 12px 8px 30px",borderRadius:8,border:`1px solid ${C.bdr}`,background:C.inp,color:C.txt,fontSize:12,boxSizing:"border-box",outline:"none"}} onFocus={e=>{e.target.style.borderColor=C.gold}} onBlur={e=>{e.target.style.borderColor=C.bdr}}/>{value&&<button onClick={()=>onChange("")} style={{position:"absolute",right:8,top:"50%",transform:"translateY(-50%)",background:"none",border:"none",color:C.mut,cursor:"pointer"}}>âœ•</button>}</div>)
}

/* ==================== ORG LOGIN ==================== */
function OrgLogin({onLogin,toast}){
  const[isReg,setIsReg]=useState(false);
  const[user,setUser]=useState("");const[pass,setPass]=useState("");const[name,setName]=useState("");const[phone,setPhone]=useState("");const[pix,setPix]=useState("");
  const[err,setErr]=useState("");const[ld,setLd]=useState(false);

  const doLogin=async()=>{
    if(!user.trim()||!pass){setErr("Preencha todos");return}setLd(true);
    try{const r=await sb.rpc("org_login",{p_username:user.trim(),p_password:pass});if(r.error){setErr(r.error);setLd(false);return}onLogin(r.org,r.token)}catch(e){setErr(e.message||"Erro de conexÃ£o")}finally{setLd(false)}
  };
  const doReg=async()=>{
    if(!user.trim()||!pass||!name.trim()||!phone.trim()||!pix.trim()){setErr("Preencha todos");return}setLd(true);
    try{const r=await sb.rpc("org_register",{p_username:user.trim(),p_password:pass,p_name:name.trim(),p_phone:phone.trim(),p_pix_key:pix.trim()});if(r.error){setErr(r.error);setLd(false);return}toast("âœ… Conta criada! FaÃ§a login.","ok");setIsReg(false);setErr("")}catch(e){setErr(e.message||"Erro")}finally{setLd(false)}
  };

  return(<div style={{display:"flex",alignItems:"center",justifyContent:"center",minHeight:"70vh",padding:16}}>
    <Card title={isReg?"ğŸ“ Cadastro":"ğŸ” Organizador"} style={{maxWidth:380,width:"100%"}}>
      {isReg?<>
        <Inp label="UsuÃ¡rio" value={user} onChange={v=>{setUser(v);setErr("")}} placeholder="seunome" required/>
        <Inp label="Senha (mÃ­n 8)" type="password" value={pass} onChange={v=>{setPass(v);setErr("")}} required/>
        <Inp label="Nome" value={name} onChange={setName} required/><Inp label="WhatsApp" value={phone} onChange={setPhone} required/><Inp label="Chave PIX" value={pix} onChange={setPix} required/>
        {err&&<div style={{padding:3,borderRadius:4,marginBottom:4,background:C.err+"11",fontSize:10,color:C.err}}>{err}</div>}
        <Btn block onClick={doReg} disabled={ld}>{ld?"Criando...":"Criar Conta"}</Btn>
        <button onClick={()=>{setIsReg(false);setErr("")}} style={{display:"block",margin:"6px auto 0",background:"none",border:"none",color:C.accent,fontSize:11,cursor:"pointer"}}>JÃ¡ tem conta? Entrar</button>
      </>:<>
        <Inp label="UsuÃ¡rio" value={user} onChange={v=>{setUser(v);setErr("")}} required/>
        <Inp label="Senha" type="password" value={pass} onChange={v=>{setPass(v);setErr("")}} required error={err}/>
        <Btn block onClick={doLogin} disabled={ld}>{ld?"Entrando...":"Entrar"}</Btn>
        <button onClick={()=>{setIsReg(true);setErr("")}} style={{display:"block",margin:"6px auto 0",background:"none",border:"none",color:C.accent,fontSize:11,cursor:"pointer"}}>Cadastre-se</button>
      </>}
    </Card>
  </div>)
}

/* ==================== ORG PANEL ==================== */
function OrgPanel({org,token,toast,config}){
  const mob=useMob();const[tab,setTab]=useState("dash");const[rifas,setRifas]=useState([]);const[ld,setLd]=useState(true);
  const load=async()=>{try{setLd(true);const r=await sb.rpc("org_get_rifas",{p_token:token});setRifas(Array.isArray(r)?r:[])}catch(e){}finally{setLd(false)}};
  useEffect(()=>{load()},[]);
  const tabs=[{id:"dash",l:"ğŸ“Š Painel"},{id:"create",l:"â• Rifa"},{id:"manage",l:"ğŸ¯ Gerenciar"},{id:"draw",l:"ğŸ† Sorteio"}];
  return(<div>
    <div style={{background:`linear-gradient(135deg,${C.bg},#12182d)`,borderBottom:`1px solid ${C.bdr}`,position:"sticky",top:0,zIndex:100}}>
      <div style={{maxWidth:960,margin:"0 auto",padding:"8px 14px"}}>
        <h1 style={{margin:0,fontSize:14,fontWeight:800,color:C.gold}}>Rifas Online</h1><p style={{margin:0,fontSize:9,color:C.mut}}>ğŸ‘¤ {org.name}</p>
        <nav style={{display:"flex",gap:2,marginTop:5,overflowX:"auto"}}>{tabs.map(t=><button key={t.id} onClick={()=>setTab(t.id)} style={{padding:"4px 8px",border:"none",borderRadius:"4px 4px 0 0",background:tab===t.id?C.gold+"18":"transparent",color:tab===t.id?C.gold:C.mut,fontSize:10,fontWeight:tab===t.id?700:500,cursor:"pointer",borderBottom:tab===t.id?`2px solid ${C.gold}`:"2px solid transparent"}}>{t.l}</button>)}</nav>
      </div>
    </div>
    <div style={{maxWidth:960,margin:"0 auto",padding:mob?"10px 10px 30px":"12px 16px 30px"}}>
      {ld?<Loading/>:<>
        {tab==="dash"&&<OrgDash rifas={rifas} setTab={setTab} config={config}/>}
        {tab==="create"&&<OrgCreate token={token} toast={toast} config={config} onCreated={()=>{load();setTab("dash")}}/>}
        {tab==="manage"&&<OrgManage rifas={rifas} token={token} toast={toast} onUpdate={load}/>}
        {tab==="draw"&&<OrgDraw rifas={rifas} token={token}/>}
      </>}
    </div>
  </div>)
}

function OrgDash({rifas,setTab,config}){
  if(!rifas.length)return<Card><div style={{textAlign:"center",padding:"30px 16px"}}><div style={{fontSize:40}}>ğŸŸï¸</div><h2 style={{fontSize:15,fontWeight:800,margin:"6px 0"}}>Crie sua primeira rifa!</h2><Btn onClick={()=>setTab("create")}>â• Criar</Btn></div></Card>;
  return<div style={{display:"flex",flexDirection:"column",gap:10}}>{rifas.map(r=>
    <Card key={r.id} title={<span><span style={{padding:"1px 5px",borderRadius:3,background:C.purp+"22",color:C.purp,fontSize:9,fontWeight:800,fontFamily:"monospace",marginRight:5}}>{r.code}</span>{r.rifa_name}</span>} subtitle={`ğŸ† ${r.prize} â€¢ ${r.status==="pending_fee"?"â³ Aguardando tarifa":r.status==="active"?"ğŸŸ¢ Ativa":"ğŸ”´ Inativa"}`}>
      
          {r.status==="pending_fee"&&<div style={{padding:10,borderRadius:8,background:C.warn+"11",border:`1px solid ${C.warn}44`}}>
          <div style={{fontSize:12,color:C.warn,fontWeight:700,marginBottom:6}}>â³ Pague a tarifa para ativar sua rifa</div>
          <div style={{background:C.bg,borderRadius:8,padding:10,textAlign:"center",marginBottom:8}}>
            <div style={{fontSize:9,color:C.mut}}>Tarifa ({r.fee_percent}%)</div>
            <div style={{fontSize:20,fontWeight:900,color:C.gold,fontFamily:"monospace"}}>{fmt(r.fee_amount)}</div>
          </div>
          {config?.pix_key?<div style={{background:C.bg,borderRadius:8,padding:10,border:`1px solid ${C.accent}22`}}>
            <div style={{fontSize:9,color:C.mut,textTransform:"uppercase",letterSpacing:1}}>Chave PIX para pagamento</div>
            <div style={{fontSize:16,fontWeight:800,color:C.accent,fontFamily:"monospace",wordBreak:"break-all",margin:"4px 0"}}>{config.pix_key}</div>
            {config.pix_name&&<div style={{fontSize:10,color:C.mut}}>Titular: {config.pix_name}</div>}
            <button onClick={()=>{navigator.clipboard.writeText(config.pix_key).then(()=>alert("ğŸ“‹ Chave PIX copiada!"))}} style={{marginTop:6,padding:"4px 10px",borderRadius:5,border:`1px solid ${C.accent}44`,background:C.accent+"11",color:C.accent,fontSize:10,fontWeight:600,cursor:"pointer"}}>ğŸ“‹ Copiar Chave PIX</button>
          </div>:<div style={{fontSize:10,color:C.err}}>âš ï¸ Chave PIX do admin nÃ£o configurada. Entre em contato.</div>}
          <div style={{fontSize:9,color:C.mut,marginTop:6}}>ApÃ³s pagar, aguarde a confirmaÃ§Ã£o do administrador. Sua rifa serÃ¡ ativada automaticamente.</div>
        </div>}}
    </Card>
  )}</div>
}

function OrgCreate({token,toast,config,onCreated}){
  const[c,sC]=useState({rifa_name:"",prize:"",prize_value:"",total_numbers:100,price_per_number:10,draw_date:"",description:""});
  const[saving,setSaving]=useState(false);const u=(k,v)=>sC(p=>({...p,[k]:v}));
  const fp=config?.fee_percent||5;const rev=c.total_numbers*c.price_per_number;const fee=rev*fp/100;
  const create=async()=>{
    if(!c.rifa_name||!c.prize){toast("Preencha nome e prÃªmio!","err");return}setSaving(true);
    try{const r=await sb.rpc("org_create_rifa",{p_token:token,p_code:genCode(),p_rifa_name:c.rifa_name,p_prize:c.prize,p_prize_value:parseFloat(c.prize_value)||0,p_total_numbers:c.total_numbers,p_price_per_number:c.price_per_number,p_draw_date:c.draw_date||"",p_description:c.description});if(r.error){toast(r.error,"err");return}toast("âœ… Rifa criada!","ok");onCreated()}catch(e){toast(e.message||"Erro","err")}finally{setSaving(false)}
  };
  return(<Card title="â• Nova Rifa">
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"0 12px"}}>
      <div style={{gridColumn:"1/-1"}}><Inp label="Nome" value={c.rifa_name} onChange={v=>u("rifa_name",v)} required/></div>
      <Inp label="PrÃªmio" value={c.prize} onChange={v=>u("prize",v)} required/><Inp label="Valor PrÃªmio" type="number" value={c.prize_value} onChange={v=>u("prize_value",v)} prefix="R$"/>
      <Inp label="Qtd NÃºmeros" type="number" value={c.total_numbers} onChange={v=>u("total_numbers",parseInt(v)||0)}/><Inp label="PreÃ§o/NÂº" type="number" value={c.price_per_number} onChange={v=>u("price_per_number",parseFloat(v)||0)} prefix="R$"/>
      <Inp label="Data Sorteio" type="date" value={c.draw_date} onChange={v=>u("draw_date",v)}/>
      <div style={{gridColumn:"1/-1"}}><Inp label="DescriÃ§Ã£o" value={c.description} onChange={v=>u("description",v)} textarea/></div>
    </div>
    <div style={{padding:8,borderRadius:6,background:C.purp+"0d",border:`1px solid ${C.purp}22`,marginBottom:8}}>
      <div style={{fontSize:10,fontWeight:700,color:C.purp}}>ğŸ’ Tarifa ({fp}%): {fmt(fee)}</div>
      <div style={{fontSize:9,color:C.mut}}>Lucro estimado: {fmt(rev-(parseFloat(c.prize_value)||0)-fee)}</div>
    </div>
    <Btn block onClick={create} disabled={saving}>{saving?"Criando...":`ğŸŸï¸ Criar Rifa (${fmt(fee)} tarifa)`}</Btn>
  </Card>)
}

function OrgManage({rifas,token,toast,onUpdate}){
  const[selId,setSelId]=useState(null);const[buyers,setBuyers]=useState([]);const[search,setSearch]=useState("");
  const rifa=rifas.find(r=>r.id===selId);
  const loadB=async id=>{try{const b=await sb.rpc("org_get_buyers",{p_token:token,p_rifa_id:id});setBuyers(Array.isArray(b)?b:[])}catch(e){}};
  useEffect(()=>{if(selId)loadB(selId)},[selId]);

  if(!rifa)return<Card title="ğŸ¯ Suas Rifas">{rifas.filter(r=>r.status==="active").length===0?<p style={{color:C.mut,fontSize:12}}>Nenhuma rifa ativa.</p>:rifas.filter(r=>r.status==="active").map(r=>
    <div key={r.id} onClick={()=>setSelId(r.id)} style={{padding:8,borderRadius:6,background:C.inp,border:`1px solid ${C.bdr}`,marginBottom:4,cursor:"pointer"}}><div style={{fontSize:12,fontWeight:700}}><span style={{color:C.purp,fontSize:9,marginRight:4}}>{r.code}</span>{r.rifa_name}</div></div>
  )}</Card>;

  const grouped={};buyers.forEach(n=>{const k=n.purchase_id||n.buyer_name;if(!grouped[k])grouped[k]={name:n.buyer_name,phone:n.buyer_phone,key:k,numbers:[],tp:0,tpd:0};grouped[k].numbers.push(n);if(n.paid)grouped[k].tp+=rifa.price_per_number;else grouped[k].tpd+=rifa.price_per_number});
  const list=Object.values(grouped).filter(b=>!search||b.name.toLowerCase().includes(search.toLowerCase()));
  const pad=rifa.total_numbers>99?3:2;
  const togglePay=async(numId,paid)=>{try{await sb.rpc("org_toggle_payment",{p_token:token,p_number_id:numId});await loadB(selId);toast(paid?"â³ Desmarcado":"âœ… Pago!","ok")}catch(e){toast(e.message||"Erro","err")}};
  const markAll=async k=>{try{await sb.rpc("org_mark_all_paid",{p_token:token,p_purchase_id:k});await loadB(selId);toast("âœ… Todos pagos!","ok")}catch(e){toast(e.message||"Erro","err")}};

  return(<div style={{display:"flex",flexDirection:"column",gap:8}}>
    <div style={{display:"flex",gap:4,alignItems:"center"}}><Btn variant="ghost" size="sm" onClick={()=>setSelId(null)}>â† Voltar</Btn><h3 style={{margin:0,fontSize:13}}>{rifa.code} â€” {rifa.rifa_name}</h3></div>
    <Card title="ğŸ‘¥ Compradores" subtitle={`${list.length}`}>
      <input type="text" placeholder="ğŸ” Buscar..." value={search} onChange={e=>setSearch(e.target.value)} style={{width:"100%",padding:"5px 8px",borderRadius:5,border:`1px solid ${C.bdr}`,background:C.inp,color:C.txt,fontSize:11,marginBottom:6,boxSizing:"border-box"}}/>
      <div style={{display:"flex",flexDirection:"column",gap:4,maxHeight:380,overflowY:"auto"}}>
        {list.map(b=>
          <div key={b.key} style={{padding:6,borderRadius:5,background:C.inp,border:`1px solid ${b.tpd>0?C.warn+"33":C.ok+"33"}`}}>
            <div style={{display:"flex",justifyContent:"space-between",marginBottom:2}}>
              <div><div style={{fontSize:11,fontWeight:700}}>{b.name}</div><div style={{fontSize:9,color:C.mut}}>{b.phone||"â€”"}</div></div>
              <div style={{fontSize:10,fontWeight:700,color:b.tpd>0?C.warn:C.ok}}>{b.tpd>0?`â³ ${fmt(b.tpd)}`:"âœ…"}</div>
            </div>
            <div style={{display:"flex",flexWrap:"wrap",gap:2,marginBottom:3}}>
              {b.numbers.map(n=><button key={n.id} onClick={()=>togglePay(n.id,n.paid)} style={{padding:"1px 4px",borderRadius:3,background:n.paid?C.ok+"22":C.warn+"22",border:`1px solid ${n.paid?C.ok+"44":C.warn+"44"}`,color:n.paid?C.ok:C.warn,fontSize:9,fontWeight:700,fontFamily:"monospace",cursor:"pointer"}}>{String(n.number).padStart(pad,"0")} {n.paid?"âœ…":"â³"}</button>)}
            </div>
            {b.tpd>0&&<Btn variant="success" size="sm" onClick={()=>markAll(b.key)}>ğŸ’° Pagar tudo</Btn>}
          </div>
        )}
        {!list.length&&<div style={{textAlign:"center",padding:12,color:C.mut,fontSize:11}}>Nenhum comprador</div>}
      </div>
    </Card>
  </div>)
}

function OrgDraw({rifas,token}){
  const[selId,setSelId]=useState(null);const[nums,setNums]=useState([]);const[winner,setWinner]=useState(null);const[drawing,setDrawing]=useState(false);const[anim,setAnim]=useState(null);
  const rifa=rifas.find(r=>r.id===selId);
  useEffect(()=>{if(selId)sb.rpc("org_get_paid_numbers",{p_token:token,p_rifa_id:selId}).then(r=>setNums(Array.isArray(r)?r:[]))},[selId]);

  if(!rifa)return<Card title="ğŸ† Sorteio">{rifas.filter(r=>r.status==="active").map(r=><div key={r.id} onClick={()=>setSelId(r.id)} style={{padding:6,borderRadius:5,background:C.inp,border:`1px solid ${C.bdr}`,marginBottom:3,cursor:"pointer"}}><div style={{fontSize:11,fontWeight:700}}>{r.code} â€” {r.rifa_name}</div></div>)}</Card>;

  const draw=()=>{
    if(nums.length<2)return;setDrawing(true);setWinner(null);let c=0;
    const iv=setInterval(()=>{setAnim(nums[sRand(nums.length)].number);c++;if(c>30){clearInterval(iv);const x=nums[sRand(nums.length)];setAnim(x.number);setWinner(x);setDrawing(false)}},80);
  };

  return(<Card title={`ğŸ† ${rifa.rifa_name}`} headerRight={<Btn variant="ghost" size="sm" onClick={()=>{setSelId(null);setWinner(null);setAnim(null)}}>â† Voltar</Btn>}>
    <div style={{textAlign:"center",padding:"10px 0"}}>
      <div style={{width:70,height:70,borderRadius:"50%",margin:"0 auto 10px",background:winner?`linear-gradient(135deg,${C.gold},#b8860b)`:C.inp,border:`3px solid ${winner?C.gold:C.bdr}`,display:"flex",alignItems:"center",justifyContent:"center"}}>
        <span style={{fontSize:anim?28:14,fontWeight:900,fontFamily:"monospace",color:winner?C.bg:drawing?C.accent:C.mut}}>{anim?String(anim).padStart(2,"0"):"?"}</span>
      </div>
      {winner&&<div style={{padding:8,borderRadius:8,background:C.gold+"0d",border:`1px solid ${C.gold}33`,marginBottom:8}}>
        <div style={{fontSize:10,color:C.gold,fontWeight:700}}>ğŸ‰ GANHADOR!</div>
        <div style={{fontSize:15,fontWeight:800}}>{winner.buyer_name}</div>
        <div style={{fontSize:10,color:C.mut}}>NÂº {String(winner.number).padStart(2,"0")} â€¢ {winner.buyer_phone||""}</div>
      </div>}
      <Btn onClick={draw} disabled={drawing||nums.length<2}>{drawing?"ğŸ°...":winner?"ğŸ”„ Novo":"ğŸ° Sortear"}</Btn>
      <div style={{fontSize:10,color:C.mut,marginTop:4}}>{nums.length} nÂº pagos</div>
    </div>
  </Card>)
}

/* ==================== ADMIN LOGIN ==================== */
function AdminLogin({onLogin,toast}){
  const[u,setU]=useState("");const[p,setP]=useState("");const[p2,setP2]=useState("");const[err,setErr]=useState("");
  const[isSetup,setIsSetup]=useState(false);const[checking,setChecking]=useState(true);
  const[pixKey,setPixKey]=useState("");const[pixName,setPixName]=useState("");const[ld,setLd]=useState(false);

  useEffect(()=>{sb.rpc("admin_check").then(r=>{setIsSetup(!r.exists);setChecking(false)}).catch(()=>setChecking(false))},[]);

  const doSetup=async()=>{
    if(!u.trim()||p.length<8){setErr("UsuÃ¡rio e senha (mÃ­n 8)");return}if(p!==p2){setErr("Senhas nÃ£o conferem");return}setLd(true);
    try{const r=await sb.rpc("admin_setup",{p_username:u.trim(),p_password:p,p_pix_key:pixKey,p_pix_name:pixName});if(r.error){setErr(r.error);return}toast("âœ… Admin configurado!","ok");setIsSetup(false);setErr("")}catch(e){setErr(e.message||"Erro")}finally{setLd(false)}
  };
  const doLogin=async()=>{
    setLd(true);try{const r=await sb.rpc("admin_login",{p_username:u.trim(),p_password:p});if(r.error){setErr(r.error);return}onLogin(r.config,r.token)}catch(e){setErr(e.message||"Erro")}finally{setLd(false)}
  };
  if(checking)return<Loading text="Verificando..."/>;
  return(<div style={{display:"flex",alignItems:"center",justifyContent:"center",minHeight:"70vh",padding:16}}>
    <Card title={isSetup?"ğŸ›¡ï¸ Configurar Admin":"ğŸ›¡ï¸ Admin"} style={{maxWidth:380,width:"100%"}}>
      {isSetup?<>
        <Inp label="UsuÃ¡rio Admin" value={u} onChange={v=>{setU(v);setErr("")}} required/><Inp label="Senha (mÃ­n 8)" type="password" value={p} onChange={v=>{setP(v);setErr("")}} required/>
        <Inp label="Confirmar Senha" type="password" value={p2} onChange={v=>{setP2(v);setErr("")}} required/>
        <Inp label="Chave PIX (tarifas)" value={pixKey} onChange={setPixKey}/><Inp label="Titular PIX" value={pixName} onChange={setPixName}/>
        {err&&<div style={{padding:3,borderRadius:4,marginBottom:4,background:C.err+"11",fontSize:10,color:C.err}}>{err}</div>}
        <Btn block onClick={doSetup} disabled={ld}>{ld?"...":"ğŸ›¡ï¸ Criar Admin"}</Btn>
      </>:<>
        <Inp label="UsuÃ¡rio" value={u} onChange={v=>{setU(v);setErr("")}} required/>
        <Inp label="Senha" type="password" value={p} onChange={v=>{setP(v);setErr("")}} required error={err}/>
        <Btn block onClick={doLogin} disabled={ld}>{ld?"...":"ğŸ›¡ï¸ Entrar"}</Btn>
      </>}
    </Card>
  </div>)
}

/* ==================== ADMIN PANEL ==================== */
function AdminPanel({cfg,token,toast}){
  const mob=useMob();const[tab,setTab]=useState("dash");
  const[rifas,setRifas]=useState([]);const[orgs,setOrgs]=useState([]);const[ld,setLd]=useState(true);const[aCfg,setACfg]=useState(cfg);

  const load=async()=>{
    try{setLd(true);const r=await sb.rpc("admin_get_all",{p_token:token});if(r.error)return;setRifas(r.rifas||[]);setOrgs(r.organizers||[]);if(r.config)setACfg(prev=>({...prev,...r.config}))}catch(e){}finally{setLd(false)}
  };
  useEffect(()=>{load()},[]);

  const act=async(action,tid,data={})=>{
    try{const r=await sb.rpc("admin_action",{p_token:token,p_action:action,p_target_id:tid,p_data:data});if(r.error){toast(r.error,"err");return false}return true}catch(e){toast(e.message||"Erro","err");return false}
  };

  const tabs=[{id:"dash",l:"ğŸ“Š"},{id:"rifas",l:"ğŸŸï¸ Rifas"},{id:"orgs",l:"ğŸ‘¥ Orgs"},{id:"fees",l:"ğŸ’ Tarifas"}];
  const totalFees=rifas.filter(r=>r.fee_paid).reduce((a,r)=>a+Number(r.fee_amount),0);
  const pendFees=rifas.filter(r=>!r.fee_paid).reduce((a,r)=>a+Number(r.fee_amount),0);

  return(<div>
    <div style={{background:`linear-gradient(135deg,${C.bg},#1a0a2e)`,borderBottom:`1px solid ${C.bdr}`,position:"sticky",top:0,zIndex:100}}>
      <div style={{maxWidth:960,margin:"0 auto",padding:"8px 14px"}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
          <h1 style={{margin:0,fontSize:14,fontWeight:800,color:C.purp}}>ğŸ›¡ï¸ ADMIN</h1>
          <div style={{display:"flex",gap:8}}>
            <div style={{textAlign:"center"}}><div style={{fontSize:12,fontWeight:700,color:C.ok,fontFamily:"monospace"}}>{fmt(totalFees)}</div><div style={{fontSize:8,color:C.mut}}>Recebido</div></div>
            <div style={{textAlign:"center"}}><div style={{fontSize:12,fontWeight:700,color:C.warn,fontFamily:"monospace"}}>{fmt(pendFees)}</div><div style={{fontSize:8,color:C.mut}}>Pendente</div></div>
          </div>
        </div>
        <nav style={{display:"flex",gap:2,marginTop:5}}>{tabs.map(t=><button key={t.id} onClick={()=>setTab(t.id)} style={{padding:"4px 8px",border:"none",borderRadius:"4px 4px 0 0",background:tab===t.id?C.purp+"18":"transparent",color:tab===t.id?C.purp:C.mut,fontSize:10,fontWeight:tab===t.id?700:500,cursor:"pointer",borderBottom:tab===t.id?`2px solid ${C.purp}`:"2px solid transparent"}}>{t.l}</button>)}</nav>
      </div>
    </div>
    <div style={{maxWidth:960,margin:"0 auto",padding:mob?"10px 10px 30px":"12px 16px 30px"}}>
      {ld?<Loading/>:<>
        {tab==="dash"&&<div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(100px,1fr))",gap:6}}>
          {[["Organizadores",orgs.length,"ğŸ‘¥",C.accent],["Rifas",rifas.length,"ğŸŸï¸",C.gold],["Ativas",rifas.filter(r=>r.status==="active").length,"ğŸŸ¢",C.ok],["Aguardando",rifas.filter(r=>r.status==="pending_fee").length,"â³",C.warn],["Taxas Receb.",fmt(totalFees),"ğŸ’",C.purp],["Taxas Pend.",fmt(pendFees),"â³",C.warn]].map(([l,v,i,c],idx)=>
            <div key={idx} style={{padding:8,borderRadius:6,background:C.card,border:`1px solid ${C.bdr}`,textAlign:"center"}}><div style={{fontSize:12}}>{i}</div><div style={{fontSize:15,fontWeight:900,color:c,fontFamily:"monospace"}}>{v}</div><div style={{fontSize:8,color:C.mut}}>{l}</div></div>
          )}
        </div>}
        {tab==="rifas"&&<Card title="ğŸŸï¸ Rifas" subtitle={`${rifas.length}`}>
          <div style={{display:"flex",flexDirection:"column",gap:5,maxHeight:460,overflowY:"auto"}}>
            {rifas.map(r=>{const org=orgs.find(o=>o.id===r.organizer_id);return(
              <div key={r.id} style={{padding:8,borderRadius:6,background:C.inp,border:`1px solid ${r.status==="pending_fee"?C.warn+"44":r.status==="active"?C.ok+"33":C.err+"33"}`}}>
                <div style={{display:"flex",justifyContent:"space-between",flexWrap:"wrap",gap:3}}>
                  <div>
                    <div style={{fontSize:12,fontWeight:700}}><span style={{color:C.purp,fontSize:9,marginRight:3}}>{r.code}</span>{r.rifa_name}</div>
                    <div style={{fontSize:10,color:C.mut}}>ğŸ‘¤ {org?.name||"?"} â€¢ ğŸ† {r.prize}</div>
                    <div style={{fontSize:10,color:C.mut}}>ğŸ’ {fmt(r.fee_amount)} ({r.fee_percent}%) â€¢ {r.fee_paid?"âœ…":"â³"}</div>
                  </div>
                  <div style={{display:"flex",gap:2,alignItems:"start"}}>
                    {r.status==="pending_fee"&&<Btn variant="success" size="sm" onClick={async()=>{if(await act("activate_rifa",r.id))load()}}>âœ… Ativar</Btn>}
                    {r.status==="active"&&<Btn variant="secondary" size="sm" onClick={async()=>{if(await act("deactivate_rifa",r.id))load()}}>â¸ï¸</Btn>}
                    <Btn variant="danger" size="sm" onClick={async()=>{if(confirm("EXCLUIR rifa?")&&await act("delete_rifa",r.id)){toast("ğŸ—‘ï¸ ExcluÃ­da","ok");load()}}}>ğŸ—‘ï¸</Btn>
                  </div>
                </div>
              </div>
            )})}
          </div>
        </Card>}
        {tab==="orgs"&&<Card title="ğŸ‘¥ Organizadores" subtitle={`${orgs.length}`}>
          <div style={{display:"flex",flexDirection:"column",gap:4,maxHeight:460,overflowY:"auto"}}>
            {orgs.map(o=>{const oR=rifas.filter(r=>r.organizer_id===o.id);return(
              <div key={o.id} style={{padding:8,borderRadius:6,background:C.inp,border:`1px solid ${o.blocked?C.err+"33":C.bdr}`}}>
                <div style={{display:"flex",justifyContent:"space-between",flexWrap:"wrap",gap:3}}>
                  <div><div style={{fontSize:12,fontWeight:700,color:o.blocked?C.err:C.txt}}>{o.name} {o.blocked&&"ğŸš«"}</div><div style={{fontSize:10,color:C.mut}}>@{o.username} â€¢ {o.phone} â€¢ {oR.length} rifa(s)</div></div>
                  <div style={{display:"flex",gap:2}}>
                    <Btn variant={o.blocked?"success":"secondary"} size="sm" onClick={async()=>{if(await act("block_org",o.id)){toast(o.blocked?"ğŸ”“":"ğŸ”’","ok");load()}}}>{o.blocked?"ğŸ”“":"ğŸ”’"}</Btn>
                    <Btn variant="danger" size="sm" onClick={async()=>{if(confirm("EXCLUIR?")&&await act("delete_org",o.id)){toast("ğŸ—‘ï¸","ok");load()}}}>ğŸ—‘ï¸</Btn>
                  </div>
                </div>
              </div>
            )})}
          </div>
        </Card>}
        {tab==="fees"&&<AdminFees aCfg={aCfg} act={act} toast={toast} load={load}/>}
      </>}
    </div>
  </div>)
}

function AdminFees({aCfg,act,toast,load}){
  const[pct,setPct]=useState(aCfg?.fee_percent||5);const[pix,setPix]=useState(aCfg?.pix_key||"");const[pixN,setPixN]=useState(aCfg?.pix_name||"");
  return(<Card title="ğŸ’ Tarifas">
    <Inp label="Percentual (%)" type="number" value={pct} onChange={setPct} suffix="%"/>
    <Inp label="Chave PIX" value={pix} onChange={setPix}/><Inp label="Titular PIX" value={pixN} onChange={setPixN}/>
    <Btn onClick={async()=>{if(await act("update_fees","00000000-0000-0000-0000-000000000000",{fee_percent:parseFloat(pct)||5,pix_key:pix,pix_name:pixN})){toast(`âœ… Tarifa: ${pct}%`,"ok");load()}}}>ğŸ’¾ Salvar</Btn>
  </Card>)
}

/* ==================== MAIN APP ==================== */
window.RifaApp=function App(){
  const mob=useMob();
  const[mode,setMode]=useState("public");
  const[orgData,setOrgData]=useState(null);const[orgToken,setOrgToken]=useState(null);
  const[adminCfg,setAdminCfg]=useState(null);const[adminToken,setAdminToken]=useState(null);
  const[config,setConfig]=useState(null);
  const[toast,showToast,hideToast]=useToast();

  useEffect(()=>{sb.rpc("get_public_config").then(setConfig).catch(()=>{})},[]);
  const logout=()=>{setMode("public");setOrgData(null);setOrgToken(null);setAdminCfg(null);setAdminToken(null)};

  return(<div style={{minHeight:"100vh",background:C.bg,color:C.txt}}>
    <Toast t={toast} onClose={hideToast}/>

    {mode==="public"&&<>
      <div style={{background:C.card,borderBottom:`1px solid ${C.bdr}`,padding:"8px 14px"}}>
        <div style={{maxWidth:780,margin:"0 auto",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
          <div style={{display:"flex",alignItems:"center",gap:6}}>
            <div style={{width:24,height:24,borderRadius:5,background:`linear-gradient(135deg,${C.gold},#b8860b)`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:11}}>ğŸŸï¸</div>
            <h1 style={{margin:0,fontSize:14,fontWeight:800,fontFamily:"'Playfair Display',Georgia,serif",background:`linear-gradient(90deg,${C.gold},${C.goldL})`,WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent"}}>Rifas Online</h1>
          </div>
          <div style={{display:"flex",gap:3}}>
            <button onClick={()=>setMode("org-login")} style={{background:"none",border:`1px solid ${C.bdr}`,borderRadius:4,color:C.mut,fontSize:9,padding:"3px 6px",cursor:"pointer"}}>ğŸ‘¤ Organizador</button>
            <button onClick={()=>setMode("admin-login")} style={{background:"none",border:`1px solid ${C.bdr}`,borderRadius:4,color:C.mut,fontSize:9,padding:"3px 6px",cursor:"pointer"}}>ğŸ›¡ï¸</button>
          </div>
        </div>
      </div>
      <PublicView toast={showToast}/>
    </>}

    {mode==="org-login"&&<>
      <div style={{padding:"4px 14px",textAlign:"center"}}><button onClick={()=>setMode("public")} style={{background:"none",border:"none",color:C.mut,fontSize:11,cursor:"pointer"}}>â† Voltar</button></div>
      <OrgLogin onLogin={(org,token)=>{setOrgData(org);setOrgToken(token);setMode("org")}} toast={showToast}/>
    </>}

    {mode==="org"&&orgData&&orgToken&&<>
      <div style={{textAlign:"right",padding:"3px 14px"}}><button onClick={logout} style={{background:"none",border:"none",color:C.mut,fontSize:10,cursor:"pointer"}}>ğŸšª Sair</button></div>
      <OrgPanel org={orgData} token={orgToken} toast={showToast} config={config}/>
    </>}

    {mode==="admin-login"&&<>
      <div style={{padding:"4px 14px",textAlign:"center"}}><button onClick={()=>setMode("public")} style={{background:"none",border:"none",color:C.mut,fontSize:11,cursor:"pointer"}}>â† Voltar</button></div>
      <AdminLogin onLogin={(cfg,token)=>{setAdminCfg(cfg);setAdminToken(token);setMode("admin")}} toast={showToast}/>
    </>}

    {mode==="admin"&&adminCfg&&adminToken&&<>
      <div style={{textAlign:"right",padding:"3px 14px"}}><button onClick={logout} style={{background:"none",border:"none",color:C.mut,fontSize:10,cursor:"pointer"}}>ğŸšª Sair</button></div>
      <AdminPanel cfg={adminCfg} token={adminToken} toast={showToast}/>
    </>}
  </div>)
};

ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(window.RifaApp));
</script>
</body>
</html>
